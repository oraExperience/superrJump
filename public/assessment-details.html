
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Assessment Details - SuperrJump</title>
<link rel="icon" type="image/png" href="logo.png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#2A6EBB",
                    "background-light": "#FFFFFF",
                    "background-dark": "#111821",
                    "accent-yellow": "#FFC857",
                    "accent-green": "#A2D7D2",
                    "text-dark": "#333333",
                    "text-light": "#F8FAFC",
                    "border-light": "#e7ecf3",
                    "border-dark": "#374151"
                },
                fontFamily: {
                    "display": ["Lexend", "sans-serif"]
                },
                borderRadius: {
                    "DEFAULT": "0.5rem",
                    "lg": "0.75rem",
                    "xl": "1rem",
                    "full": "9999px"
                },
            },
        },
    }
</script>
<style>
    body {
        font-family: 'Lexend', sans-serif;
    }
    .material-symbols-outlined {
        font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }

    /* Animated progress bar shimmer effect */
    @keyframes shimmer {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }
    
    .progress-shimmer {
        background: linear-gradient(
            90deg,
            #2A6EBB 0%,
            #4A8ED8 25%,
            #FFC857 50%,
            #4A8ED8 75%,
            #2A6EBB 100%
        );
        background-size: 200% 100%;
        animation: shimmer 2s linear infinite;
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    /* Processing Ques - Light Blue */
    .status-processing-ques {
        background-color: #DBEAFE;
        color: #1E40AF;
    }
    
    /* Ques Pending Approval - Light Yellow */
    .status-ques-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }
    
    /* Processing Ans - Light Blue */
    .status-processing-ans {
        background-color: #DBEAFE;
        color: #1E40AF;
    }
    
    /* Ans Pending Approval - Light Yellow */
    .status-ans-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }
    
    /* Completed - Light Green */
    .status-completed {
        background-color: #D1FAE5;
        color: #065F46;
    }

    /* Legacy status classes for backward compatibility */
    .status-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }

    .status-approved {
        background-color: #D1FAE5;
        color: #065F46;
    }

    .status-in-progress {
        background-color: #DBEAFE;
        color: #1E40AF;
    }

    .status-pending-verification {
        background-color: #FEF3C7;
        color: #92400E;
    }

    .dark .status-pending {
        background-color: #78350F;
        color: #FEF3C7;
    }

    .dark .status-pending-verification {
        background-color: #78350F;
        color: #FEF3C7;
    }

    .dark .status-approved {
        background-color: #064E3B;
        color: #D1FAE5;
    }

    .dark .status-completed {
        background-color: #064E3B;
        color: #D1FAE5;
    }

    .dark .status-in-progress {
        background-color: #1E3A8A;
        color: #DBEAFE;
    }

    /* Quote fade animation */
    #inspirationalQuote {
        transition: opacity 0.3s ease-in-out;
    }
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-dark dark:text-text-light">
<div class="relative flex min-h-screen w-full flex-col">

<!-- Sidebar Menu -->
<div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-slate-800 border-r border-border-light dark:border-border-dark transform -translate-x-full transition-transform duration-300 ease-in-out">
<div class="flex flex-col h-full">
<!-- Sidebar Header -->
<div class="flex items-center justify-between px-6 py-4 border-b border-border-light dark:border-border-dark">
<div class="flex items-center gap-2">
<div class="text-primary size-6">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-lg font-bold text-text-dark dark:text-text-light">SuperrJump</h2>
</div>
<button onclick="toggleSidebar()" class="text-text-dark dark:text-text-light hover:text-primary transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>

<!-- Sidebar Menu Items -->
<nav class="flex-1 px-4 py-6 space-y-2">
<a href="/assessments.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary/10 text-primary font-medium transition-colors">
<span class="material-symbols-outlined">assignment</span>
<span>Assessments</span>
</a>
<a href="/profile.html" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light transition-colors">
<span class="material-symbols-outlined">person</span>
<span>Profile</span>
</a>
</nav>

<!-- Sidebar Footer -->
<div class="mt-auto px-4 py-4 border-t border-border-light dark:border-border-dark">
<button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
<span class="material-symbols-outlined">logout</span>
<span>Logout</span>
</button>
</div>
</div>
</div>

<!-- Sidebar Backdrop -->
<div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleSidebar()"></div>

<!-- TopNavBar -->
<header class="sticky top-0 z-30 flex items-center justify-center border-b border-border-light dark:border-border-dark bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
<div class="flex items-center justify-between w-full max-w-7xl px-4 py-3 md:px-8">
<div class="flex items-center gap-3 text-text-dark dark:text-text-light">
<button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors flex items-center justify-center">
<span class="material-symbols-outlined text-2xl">menu</span>
</button>
<div class="text-primary flex items-center" style="width: 28px; height: 28px;">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-xl font-bold leading-none">SuperrJump</h2>
</div>
<div class="flex items-center gap-4">
<span id="orgName" class="text-sm font-medium">Organization Name</span>
</div>
</div>
</header>

<main class="flex flex-col items-center w-full flex-1">
<div class="w-full max-w-7xl px-4 md:px-8 py-10">
<!-- Back Button -->
<div class="mb-6">
<button onclick="window.location.href='/assessments.html'" class="inline-flex items-center gap-2 text-primary hover:text-blue-700 transition-colors">
<span class="material-symbols-outlined">arrow_back</span>
<span class="font-medium">Back to Assessments</span>
</button>
</div>

<!-- Assessment Info Header -->
<div class="mb-8 bg-gradient-to-r from-accent-yellow/20 to-accent-yellow/5 dark:from-accent-yellow/10 dark:to-accent-yellow/5 p-6 rounded-xl border-l-4 border-accent-yellow">
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
<div>
<h1 class="text-3xl font-bold mb-2" id="assessmentTitle">Loading...</h1>
<div class="flex flex-wrap gap-4 text-sm text-text-dark/70 dark:text-text-light/70">
<span class="flex items-center">
<span id="assessmentNumber">-</span>
</span>
<span class="flex items-center gap-1">
<span class="material-symbols-outlined !text-base">school</span>
<span id="assessmentClass">-</span>
</span>
<span class="flex items-center gap-1">
<span class="material-symbols-outlined !text-base">menu_book</span>
<span id="assessmentSubject">-</span>
</span>
<span class="flex items-center gap-1">
<span class="material-symbols-outlined !text-base">calendar_today</span>
<span id="assessmentDate">-</span>
</span>
</div>
</div>
<div>
<span id="assessmentStatus" class="status-badge">Status</span>
</div>
</div>
</div>

<!-- Extraction In Progress Section -->
<div id="extractionProgressSection" class="hidden mb-6">
<div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6 border-l-4 border-primary shadow-md">
<div class="flex items-start gap-4">
<span class="material-symbols-outlined text-3xl text-primary dark:text-blue-400 animate-spin">autorenew</span>
<div class="flex-1">
<h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">AI is Extracting Questions...</h3>
<p class="text-base text-text-dark/70 dark:text-text-light/70 mb-4">Our AI is analyzing your question paper and extracting questions. This process continues in the background.</p>
<button onclick="checkExtractionStatus()" class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-md">
<span class="material-symbols-outlined">refresh</span>
<span>Check Extraction Status</span>
</button>
</div>
</div>
</div>
</div>

<!-- Verification Pending Section (shown after extraction completes) -->
<div id="verificationPendingSection" class="hidden mb-6">
<div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-6 border-l-4 border-accent-yellow shadow-md">
<div class="flex items-start gap-4">
<span class="material-symbols-outlined text-3xl text-accent-yellow">pending_actions</span>
<div class="flex-1">
<h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">Question Extraction Complete!</h3>
<p class="text-base text-text-dark/70 dark:text-text-light/70 mb-4">AI has extracted <span id="extractedQuestionsCount" class="font-semibold">0</span> questions from your question paper. Please verify and finalize the questions before uploading answer sheets.</p>
<button onclick="goToVerification()" class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-md">
<span class="material-symbols-outlined">fact_check</span>
<span>Verify Questions Now</span>
</button>
</div>
</div>
</div>
</div>

<!-- Answer Sheet Upload Section (shown only after verification) -->
<div id="answerSheetUploadSection" class="hidden mb-6">
<div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-6 border-l-4 border-green-500 shadow-md">
<div class="flex items-start gap-4 mb-4">
<span class="material-symbols-outlined text-3xl text-green-600 dark:text-green-400">check_circle</span>
<div class="flex-1">
<h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">Questions Verified Successfully</h3>
<p class="text-base text-text-dark/70 dark:text-text-light/70 mb-4">Your assessment has <span id="verifiedQuestionsCount" class="font-semibold">0</span> verified questions. You can now upload answer sheets for grading.</p>
</div>
</div>

<!-- Answer Sheet Upload Area -->
<div class="bg-white dark:bg-slate-700 rounded-xl p-6 border-2 border-dashed border-gray-300 dark:border-slate-600 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer" id="answerSheetArea" onclick="document.getElementById('answerSheetInput').click()">
<input type="file" id="answerSheetInput" class="hidden" accept=".pdf" onchange="handleAnswerSheetUpload(this)" multiple />
<div class="text-center">
<span class="material-symbols-outlined text-5xl text-primary mb-2">upload_file</span>
<p class="text-lg font-semibold text-text-dark dark:text-text-light mb-1">Upload Answer Sheets</p>
<p class="text-sm text-text-dark/70 dark:text-text-light/70">Click to upload or drag and drop PDF files here</p>
<p class="text-xs text-text-dark/60 dark:text-text-light/60 mt-2">You can upload multiple answer sheets at once</p>
</div>
</div>
</div>
</div>

<!-- AI Grading Progress (shown only for In Progress assessments) -->
<div id="gradingProgressSection" class="hidden mb-6">
<!-- Main Card with Blue Background -->
<div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6 border-l-4 border-primary shadow-md">
<div class="flex items-start gap-4 mb-6">
<span class="material-symbols-outlined text-3xl text-primary dark:text-blue-400 animate-spin">autorenew</span>
<div class="flex-1">
<h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">AI is Grading Your Assessment</h3>
<p class="text-base text-text-dark/70 dark:text-text-light/70">Sit back and relax! Our AI is analyzing all student responses. This usually takes a few minutes. We'll notify you once grading is complete.</p>
</div>
</div>

<!-- Inspirational Quote Card -->
<div class="bg-white dark:bg-slate-700 rounded-xl p-5 border-l-4 border-primary shadow-md">
<p class="text-lg font-medium text-text-dark dark:text-text-light italic leading-relaxed" id="inspirationalQuote">The beautiful thing about learning is that no one can take it away from you.</p>
</div>
</div>
</div>

<!-- Filters Section -->
<div class="mb-6">
<div class="flex flex-col md:flex-row gap-4 md:items-center">
<input
type="text"
id="filterStudentId"
placeholder="Student ID"
class="w-full md:w-auto px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
oninput="applyFilters()"
/>

<input
type="text"
id="filterStudentName"
placeholder="Search by Name"
class="w-full md:flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
oninput="applyFilters()"
/>

<select
id="filterStatus"
class="w-full md:w-auto pl-4 pr-10 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
onchange="applyFilters()"
>
<option value="">All Status</option>
<option value="Pending">Pending</option>
<option value="Approved">Approved</option>
</select>

<button
onclick="clearFilters()"
class="w-full md:w-auto px-4 py-2 text-sm font-medium text-primary hover:text-blue-700 dark:hover:text-blue-400 transition-colors whitespace-nowrap"
>
Clear
</button>
</div>
</div>

<!-- Students Table -->
<div class="-mx-4 md:mx-0 bg-white dark:bg-slate-800 md:rounded-xl shadow-lg border-y md:border border-border-light dark:border-border-dark overflow-hidden">
<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
<h2 class="text-xl font-bold">Student Results</h2>
<p class="text-sm text-text-dark/70 dark:text-text-light/70 mt-1">Review and approve student grades</p>
</div>

<div class="overflow-x-auto">
<table class="w-full min-w-[700px]">
<thead class="bg-primary">
<tr>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Student ID</th>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Student Name</th>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Marks</th>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Status</th>
<th class="px-6 py-5 text-center text-sm font-bold text-white uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="studentsTableBody">
<!-- Students will be dynamically generated here -->
</tbody>
</table>
</div>

<!-- Table Footer -->
<div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-700/50">
<div class="text-sm text-text-dark/70 dark:text-text-light/70">
Total Students: <span id="totalStudents" class="font-semibold">0</span>
</div>
</div>
</div>
</div>
</main>

<!-- Footer -->
<footer class="flex justify-center w-full mt-10 border-t border-border-light dark:border-border-dark">
<div class="w-full max-w-7xl px-4 py-8 md:px-8">
<div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
<div class="flex items-center gap-3">
<div class="text-primary size-6">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-lg font-bold">SuperrJump</h2>
</div>
</div>
</div>
</footer>
</div>

<script>
// Check if user is logged in
const user = JSON.parse(sessionStorage.getItem('user'));

if (!user) {
    window.location.href = '/login';
} else {
    const orgName = user.organization || user.organisationName || user.organisation || 'SuperrJump Academy';
    document.getElementById('orgName').textContent = orgName;
}

function logout() {
    sessionStorage.removeItem('user');
    window.location.href = '/login';
}

// Sidebar toggle functionality
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('sidebarBackdrop');
    
    if (sidebar.classList.contains('-translate-x-full')) {
        sidebar.classList.remove('-translate-x-full');
        backdrop.classList.remove('hidden');
    } else {
        sidebar.classList.add('-translate-x-full');
        backdrop.classList.add('hidden');
    }
}

// API configuration
const API_BASE_URL = 'http://localhost:3000/api';

// Get assessment ID from URL
const urlParams = new URLSearchParams(window.location.search);
const assessmentId = urlParams.get('id');

// Handle browser back button - show logout confirmation
window.addEventListener('popstate', (event) => {
    const token = sessionStorage.getItem('token');
    
    if (token) {
        // Prevent actual navigation
        window.history.pushState(null, null, window.location.href);
        
        // Show confirmation dialog
        const confirmed = confirm('Going back will log you out. Do you want to continue?');
        
        if (confirmed) {
            // User confirmed - log out and redirect to login
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.replace('/login.html');
        }
    }
});



if (!assessmentId) {
    window.location.href = '/assessments.html';
}

// Store assessment data
let assessmentData = null;

// Load assessment details from API
async function loadAssessmentDetails() {
    try {
        // Get JWT token from session
        const token = sessionStorage.getItem('token');
        
        if (!token) {
            // Redirect to login if no token
            window.location.href = '/login.html';
            return;
        }
        
        // Fetch assessment from API
        const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}`, {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.status === 401 || response.status === 403) {
            // Token expired or invalid - redirect to login
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.href = '/login.html';
            return;
        }
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        assessmentData = data.assessment;
        
        // Display assessment details
        const date = new Date(assessmentData.created_at);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        document.getElementById('assessmentTitle').textContent = assessmentData.title;
        document.getElementById('assessmentNumber').textContent = `#${assessmentData.id}`;
        document.getElementById('assessmentClass').textContent = assessmentData.class;
        document.getElementById('assessmentSubject').textContent = assessmentData.subject;
        document.getElementById('assessmentDate').textContent = dateStr;
        
        const statusBadge = document.getElementById('assessmentStatus');
        statusBadge.textContent = assessmentData.status;
        
        // Map status to CSS classes
        let statusClass = 'status-processing-ques'; // default
        if (assessmentData.status === 'Completed') {
            statusClass = 'status-completed';
        } else if (assessmentData.status === 'Processing Ques') {
            statusClass = 'status-processing-ques';
        } else if (assessmentData.status === 'Ques Pending Approval') {
            statusClass = 'status-ques-pending';
        } else if (assessmentData.status === 'Processing Ans') {
            statusClass = 'status-processing-ans';
        } else if (assessmentData.status === 'Ans Pending Approval') {
            statusClass = 'status-ans-pending';
        }
        
        statusBadge.className = `status-badge ${statusClass}`;
        
        // Show appropriate section based on status
        if (assessmentData.status === 'Processing Ques') {
            // AI is extracting questions - show loader
            showExtractionProgress();
        } else if (assessmentData.status === 'Ques Pending Approval') {
            // Questions extracted, need teacher verification
            if (assessmentData.question_count && assessmentData.question_count > 0) {
                document.getElementById('extractedQuestionsCount').textContent = assessmentData.question_count;
                showVerificationPending();
            } else {
                // Fallback to extraction progress if question count not available
                showExtractionProgress();
            }
        } else if (assessmentData.status === 'Processing Ans') {
            // AI is grading answers - show grading progress with loader
            showGradingProgress();
        } else if (assessmentData.status === 'Ans Pending Approval') {
            // Grades ready for teacher review - show student results table for approval
            showCompletedState();
        } else if (assessmentData.status === 'Completed') {
            // Assessment fully completed - show student results table
            showCompletedState();
        }
    } catch (error) {
        console.error('Error fetching assessment:', error);
        alert('Failed to load assessment details. Redirecting to assessments page...');
        setTimeout(() => {
            window.location.href = '/assessments.html';
        }, 2000);
    }
}

// Show extraction progress section
function showExtractionProgress() {
    const extractionSection = document.getElementById('extractionProgressSection');
    extractionSection.classList.remove('hidden');
    
    // Start polling for extraction completion
    pollExtractionStatus();
}

// Poll backend for extraction status
let extractionPollInterval = null;

async function pollExtractionStatus() {
    // Clear any existing poll interval
    if (extractionPollInterval) {
        clearInterval(extractionPollInterval);
    }
    
    // Poll every 5 seconds
    extractionPollInterval = setInterval(async () => {
        try {
            const token = sessionStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const assessment = data.assessment;
                
                // Check if status changed from "Processing Ques"
                if (assessment.status !== 'Processing Ques') {
                    clearInterval(extractionPollInterval);
                    // Reload page to show new status
                    window.location.reload();
                }
            }
        } catch (error) {
            console.error('Error polling extraction status:', error);
        }
    }, 5000); // Check every 5 seconds
}

// Stop polling when page is unloaded
window.addEventListener('beforeunload', () => {
    if (extractionPollInterval) {
        clearInterval(extractionPollInterval);
    }
});

// Show verification pending section (after extraction completes)
function showVerificationPending() {
    const verificationSection = document.getElementById('verificationPendingSection');
    
    // Use actual question count from assessment data
    const extractedCount = assessmentData?.questionCount || Math.floor(Math.random() * 11) + 5;
    document.getElementById('extractedQuestionsCount').textContent = extractedCount;
    
    // Show the verification section
    verificationSection.classList.remove('hidden');
}

// Show answer sheet upload section (after verification)
function showAnswerSheetUpload() {
    const uploadSection = document.getElementById('answerSheetUploadSection');
    
    // Use actual question count from assessment data if available, otherwise use mock data
    const verifiedCount = assessmentData?.questionCount || Math.floor(Math.random() * 11) + 5;
    document.getElementById('verifiedQuestionsCount').textContent = verifiedCount;
    
    // Show the upload section
    uploadSection.classList.remove('hidden');
}

// Show grading progress message
function showGradingProgress() {
    const progressSection = document.getElementById('gradingProgressSection');

    // Show the progress section
    progressSection.classList.remove('hidden');
    
    // Rotate inspirational quotes
    rotateQuotes();
    
    // Simulate grading completion after some time
    simulateGradingCompletion();
}

// Show completed state (assessment fully graded)
function showCompletedState() {
    // Just show the student results table which is already rendered
    // No special section needed for completed assessments
    console.log('Assessment is completed - showing student results');
}

// Simulate grading completion
function simulateGradingCompletion() {
    // Random time between 30-60 seconds
    const completionTime = Math.floor(Math.random() * 30000) + 30000;
    
    setTimeout(() => {
        // Update grading state to completed but keep the data
        const gradingState = sessionStorage.getItem('gradingState');
        if (gradingState) {
            try {
                const state = JSON.parse(gradingState);
                state.isGrading = false;
                state.status = 'Completed';
                state.completedAt = new Date().toISOString();
                sessionStorage.setItem('gradingState', JSON.stringify(state));
            } catch (error) {
                console.error('Error updating grading state:', error);
            }
        }
        
        // Update status to completed
        const statusBadge = document.getElementById('assessmentStatus');
        statusBadge.textContent = 'Completed';
        statusBadge.className = 'status-badge status-completed';
        
        // Hide grading progress section
        const progressSection = document.getElementById('gradingProgressSection');
        progressSection.classList.add('hidden');
        
        // Show completion notification
        showCompletionNotification();
    }, completionTime);
}

// Show completion notification
function showCompletionNotification() {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center gap-3 animate-bounce';
    notification.innerHTML = `
        <span class="material-symbols-outlined">check_circle</span>
        <div>
            <p class="font-semibold">Grading Complete!</p>
            <p class="text-sm">Your assessment has been graded successfully.</p>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 5 seconds
    setTimeout(() => {
        notification.style.transition = 'opacity 0.3s ease';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Navigate to verification page
function goToVerification() {
    window.location.href = `/verify-questions.html?id=${assessmentId}`;
}

// Handle answer sheet upload
function handleAnswerSheetUpload(input) {
    if (input.files && input.files.length > 0) {
        const fileCount = input.files.length;
        const fileNames = Array.from(input.files).map(f => f.name).join(', ');
        
        // Show success message
        const uploadArea = document.getElementById('answerSheetArea');
        uploadArea.innerHTML = `
            <div class="text-center">
                <span class="material-symbols-outlined text-5xl text-green-600 mb-2">check_circle</span>
                <p class="text-lg font-semibold text-text-dark dark:text-text-light mb-1">
                    ${fileCount} Answer Sheet${fileCount > 1 ? 's' : ''} Uploaded Successfully
                </p>
                <p class="text-sm text-text-dark/70 dark:text-text-light/70 mb-3">${fileNames}</p>
                <button onclick="startGrading()" class="px-6 py-3 bg-primary hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-md">
                    Start AI Grading
                </button>
            </div>
        `;
    }
}

// Start grading process
function startGrading() {
    // Update status to "In Progress"
    const statusBadge = document.getElementById('assessmentStatus');
    statusBadge.textContent = 'In Progress';
    statusBadge.className = 'status-badge status-in-progress';
    
    // Hide upload section, show grading progress
    document.getElementById('answerSheetUploadSection').classList.add('hidden');
    showGradingProgress();
}

// Rotate inspirational quotes
function rotateQuotes() {
    const quotes = [
        "The beautiful thing about learning is that no one can take it away from you.",
        "Education is the most powerful weapon which you can use to change the world.",
        "The expert in anything was once a beginner.",
        "Learning is a treasure that will follow its owner everywhere.",
        "The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice."
    ];
    const quoteElement = document.getElementById('inspirationalQuote');
    
    // Add transition style
    quoteElement.style.transition = 'opacity 0.3s ease';
    
    let quoteIndex = 0;
    
    // Change quote every 6 seconds with fade effect
    setInterval(() => {
        quoteIndex = (quoteIndex + 1) % quotes.length;
        quoteElement.style.opacity = '0';
        
        setTimeout(() => {
            quoteElement.textContent = quotes[quoteIndex];
            quoteElement.style.opacity = '1';
        }, 300);
    }, 6000);
}

// Generate student results from API
async function generateStudentResults() {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading student submissions...</td></tr>';
    
    try {
        const token = sessionStorage.getItem('token');
        
        // Fetch student submissions from API
        const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}/submissions`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch student submissions');
        }
        
        const data = await response.json();
        const submissions = data.submissions || [];
        
        tbody.innerHTML = '';
        
        if (submissions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No student submissions found</td></tr>';
            document.getElementById('totalStudents').textContent = '0';
            return;
        }
        
        // Get total marks for the assessment
        const totalMarks = parseFloat(assessmentData.total_marks || 100);
        
        submissions.forEach(submission => {
            const row = document.createElement('tr');
            row.className = 'student-row hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors';
            row.setAttribute('data-student-id', submission.student_id);
            row.setAttribute('data-student-name', submission.student_name.toLowerCase());
            row.setAttribute('data-status', submission.submission_status);
            
            // Format marks to remove trailing zeros
            const marksObtained = parseFloat(submission.total_marks_obtained);
            const formattedMarks = marksObtained % 1 === 0 ? Math.floor(marksObtained) : marksObtained;
            const formattedTotal = totalMarks % 1 === 0 ? Math.floor(totalMarks) : totalMarks;
            
            row.innerHTML = `
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <div class="text-sm font-semibold text-text-dark dark:text-text-light">${submission.student_id}</div>
                </td>
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <div class="text-sm font-medium text-text-dark dark:text-text-light">${submission.student_name}</div>
                </td>
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <div class="text-sm font-semibold text-text-dark dark:text-text-light">${formattedMarks}/${formattedTotal}</div>
                </td>
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <span class="status-badge status-${submission.submission_status.toLowerCase()}">${submission.submission_status}</span>
                </td>
                <td class="px-6 py-4 text-center">
                    <button onclick="viewStudentDetails('${submission.student_id}')" class="inline-flex items-center justify-center w-9 h-9 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors" title="View Details">
                        <span class="material-symbols-outlined text-primary">visibility</span>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        document.getElementById('totalStudents').textContent = submissions.length;
    } catch (error) {
        console.error('Error loading student submissions:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading student submissions</td></tr>';
    }
}

function viewStudentDetails(studentId) {
    // Navigate to the student review page
    window.location.href = `/student-review.html?studentId=${studentId}&assessmentId=${assessmentId}`;
}

// Filter functionality
function applyFilters() {
    const filterStudentId = document.getElementById('filterStudentId').value.toLowerCase();
    const filterStudentName = document.getElementById('filterStudentName').value.toLowerCase();
    const filterStatus = document.getElementById('filterStatus').value;
    
    const rows = document.querySelectorAll('.student-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let showRow = true;
        
        const studentId = row.getAttribute('data-student-id').toLowerCase();
        const studentName = row.getAttribute('data-student-name');
        const status = row.getAttribute('data-status');
        
        // Apply Student ID filter
        if (filterStudentId && !studentId.includes(filterStudentId)) {
            showRow = false;
        }
        
        // Apply Student Name filter
        if (filterStudentName && !studentName.includes(filterStudentName)) {
            showRow = false;
        }
        
        // Apply Status filter
        if (filterStatus && status !== filterStatus) {
            showRow = false;
        }
        
        // Show/hide row
        if (showRow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update total count
    document.getElementById('totalStudents').textContent = visibleCount;
}

function clearFilters() {
    document.getElementById('filterStudentId').value = '';
    document.getElementById('filterStudentName').value = '';
    document.getElementById('filterStatus').value = '';
    
    const rows = document.querySelectorAll('.student-row');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    document.getElementById('totalStudents').textContent = rows.length;
}

// Initialize page
loadAssessmentDetails();
generateStudentResults();
</script>
</body>
</html>
