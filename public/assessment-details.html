
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Assessment Details - SuperrJump</title>
<link rel="icon" type="image/png" href="logo.png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#2A6EBB",
                    "background-light": "#FFFFFF",
                    "background-dark": "#111821",
                    "accent-yellow": "#FFC857",
                    "accent-green": "#A2D7D2",
                    "text-dark": "#333333",
                    "text-light": "#F8FAFC",
                    "border-light": "#e7ecf3",
                    "border-dark": "#374151"
                },
                fontFamily: {
                    "display": ["Lexend", "sans-serif"]
                },
                borderRadius: {
                    "DEFAULT": "0.5rem",
                    "lg": "0.75rem",
                    "xl": "1rem",
                    "full": "9999px"
                },
            },
        },
    }
</script>
<style>
    body {
        font-family: 'Lexend', sans-serif;
    }
    .material-symbols-outlined {
        font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }

    /* Animated progress bar shimmer effect */
    @keyframes shimmer {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }
    
    .progress-shimmer {
        background: linear-gradient(
            90deg,
            #2A6EBB 0%,
            #4A8ED8 25%,
            #FFC857 50%,
            #4A8ED8 75%,
            #2A6EBB 100%
        );
        background-size: 200% 100%;
        animation: shimmer 2s linear infinite;
    }

    /* Quote fade animation */
    #processingQuote {
        transition: opacity 0.3s ease-in-out;
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    /* Processing Ques - Light Blue */
    .status-processing-ques {
        background-color: #DBEAFE;
        color: #1E40AF;
    }
    
    /* Ques Pending Approval - Light Yellow */
    .status-ques-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }
    
    /* Processing Ans - Light Blue */
    .status-processing-ans {
        background-color: #DBEAFE;
        color: #1E40AF;
    }
    
    /* Ans Pending Approval - Light Yellow */
    .status-ans-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }
    
    /* Completed - Light Green */
    .status-completed {
        background-color: #D1FAE5;
        color: #065F46;
    }

    /* Failed - Light Red */
    .status-failed {
        background-color: #FEE2E2;
        color: #DC2626;
    }

    /* Submission Status Classes */
    .status-processing {
        background-color: #DBEAFE;
        color: #1E40AF;
    }

    .status-ready.for.verification,
    .status-ready-for-verification {
        background-color: #FEF3C7;
        color: #92400E;
    }

    .status-verifying {
        background-color: #E0E7FF;
        color: #4338CA;
    }

    .status-approved {
        background-color: #D1FAE5;
        color: #065F46;
    }

    /* Legacy status classes for backward compatibility */
    .status-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }

    .status-in-progress {
        background-color: #DBEAFE;
        color: #1E40AF;
    }

    .status-pending-verification {
        background-color: #FEF3C7;
        color: #92400E;
    }

    .dark .status-processing {
        background-color: #1E3A8A;
        color: #DBEAFE;
    }

    .dark .status-ready-for-verification {
        background-color: #78350F;
        color: #FEF3C7;
    }

    .dark .status-verifying {
        background-color: #312E81;
        color: #E0E7FF;
    }

    .dark .status-pending {
        background-color: #78350F;
        color: #FEF3C7;
    }

    .dark .status-pending-verification {
        background-color: #78350F;
        color: #FEF3C7;
    }

    .dark .status-approved {
        background-color: #064E3B;
        color: #D1FAE5;
    }

    .dark .status-completed {
        background-color: #064E3B;
        color: #D1FAE5;
    }

    .dark .status-failed {
        background-color: #7F1D1D;
        color: #FCA5A5;
    }

    .dark .status-in-progress {
        background-color: #1E3A8A;
        color: #DBEAFE;
    }

    /* Quote fade animation */
    #inspirationalQuote {
        transition: opacity 0.3s ease-in-out;
    }
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-dark dark:text-text-light">
<div class="relative flex min-h-screen w-full flex-col">

<!-- Sidebar Menu -->
<div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-slate-800 border-r border-border-light dark:border-border-dark transform -translate-x-full transition-transform duration-300 ease-in-out">
<div class="flex flex-col h-full">
<!-- Sidebar Header -->
<div class="flex items-center justify-between px-6 py-4 border-b border-border-light dark:border-border-dark">
<div class="flex items-center gap-2">
<div class="text-primary size-6">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-lg font-bold text-text-dark dark:text-text-light">SuperrJump</h2>
</div>
<button onclick="toggleSidebar()" class="text-text-dark dark:text-text-light hover:text-primary transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>

<!-- Sidebar Menu Items -->
<nav class="flex-1 px-4 py-6 space-y-2">
<a href="/dashboard" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light transition-colors">
<span class="material-symbols-outlined">dashboard</span>
<span>Dashboard</span>
</a>
<a href="/assessments" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary/10 text-primary font-medium transition-colors">
<span class="material-symbols-outlined">assignment</span>
<span>Assessments</span>
</a>
<a href="/students" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light transition-colors">
<span class="material-symbols-outlined">school</span>
<span>Students</span>
</a>
<a href="/profile" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light transition-colors">
<span class="material-symbols-outlined">person</span>
<span>Profile</span>
</a>
</nav>

<!-- Sidebar Footer -->
<div class="mt-auto px-4 py-4 border-t border-border-light dark:border-border-dark">
<button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
<span class="material-symbols-outlined">logout</span>
<span>Logout</span>
</button>
</div>
</div>
</div>

<!-- Sidebar Backdrop -->
<div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleSidebar()"></div>

<!-- TopNavBar -->
<header class="sticky top-0 z-30 flex items-center justify-center border-b border-border-light dark:border-border-dark bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
<div class="flex items-center justify-between w-full max-w-7xl px-3 py-2 md:px-8 md:py-3">
<div class="flex items-center gap-2 md:gap-3 text-text-dark dark:text-text-light">
<button onclick="toggleSidebar()" class="p-1.5 md:p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors flex items-center justify-center">
<span class="material-symbols-outlined text-xl md:text-2xl">menu</span>
</button>
<a href="/dashboard" class="flex items-center gap-2 md:gap-3 hover:opacity-80 transition-opacity cursor-pointer">
<div class="text-primary flex items-center" style="width: 24px; height: 24px;">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-lg md:text-xl font-bold leading-none">SuperrJump</h2>
</a>
</div>
<div class="flex items-center gap-4">
    <span id="orgName" class="text-xs md:text-sm font-medium truncate max-w-[150px] md:max-w-none">Organization Name</span>
</div>
</div>
</header>

<!-- Assessment Questions Modal -->
<div id="questionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/30 dark:to-purple-900/30 p-6 border-b-4 border-primary flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-4xl text-primary">quiz</span>
                <div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Assessment questions</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Reference while verifying student answers</p>
                </div>
            </div>
            <button onclick="toggleQuestionsModal()" class="p-2 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-2xl text-gray-600 dark:text-gray-400">close</span>
            </button>
        </div>
        
        <!-- Questions List -->
        <div class="flex-1 overflow-y-auto p-6" id="assessmentQuestionsList">
            <div class="text-center text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined text-4xl mb-2 block">hourglass_empty</span>
                <p>Loading questions...</p>
            </div>
        </div>
    </div>
</div>

<main class="flex flex-col items-center w-full flex-1">
<div class="w-full max-w-7xl px-4 md:px-8 py-6 md:py-10">
<!-- Back Button -->
<div class="mb-4 md:mb-6">
<button onclick="goBackToSource()" class="inline-flex items-center gap-2 text-primary hover:text-blue-700 transition-colors text-sm md:text-base">
<span class="material-symbols-outlined text-xl md:text-2xl">arrow_back</span>
<span class="font-medium" id="backButtonText">Back to Assessments</span>
</button>
</div>

<!-- Assessment Info Header -->
<div class="mb-6 md:mb-8 bg-gradient-to-r from-accent-yellow/20 to-accent-yellow/5 dark:from-accent-yellow/10 dark:to-accent-yellow/5 p-4 md:p-6 rounded-xl border-l-4 border-accent-yellow">
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4">
<div>
<h1 class="text-2xl md:text-3xl font-bold mb-2" id="assessmentTitle">Loading...</h1>
<div class="flex flex-wrap gap-3 md:gap-4 text-xs md:text-sm text-text-dark/70 dark:text-text-light/70">
<span class="flex items-center">
<span id="assessmentNumber">-</span>
</span>
<span class="flex items-center gap-1">
<span class="material-symbols-outlined !text-sm md:!text-base">school</span>
<span id="assessmentClass">-</span>
</span>
<span class="flex items-center gap-1">
<span class="material-symbols-outlined !text-sm md:!text-base">menu_book</span>
<span id="assessmentSubject">-</span>
</span>
<span class="flex items-center gap-1">
<span class="material-symbols-outlined !text-base">calendar_today</span>
<span id="assessmentDate">-</span>
</span>
</div>
</div>
<div>
<span id="assessmentStatus" class="status-badge">Status</span>
</div>
</div>
</div>

<!-- Extraction In Progress Section -->
<div id="extractionProgressSection" class="hidden mb-6">
<!-- Main Card with Blue Background -->
<div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6 border-l-4 border-primary shadow-md">
<div class="flex items-start gap-4 mb-6">
<span class="material-symbols-outlined text-3xl text-primary dark:text-blue-400 animate-spin">autorenew</span>
<div class="flex-1">
<h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">AI is Extracting Questions...</h3>
<p class="text-base text-text-dark/70 dark:text-text-light/70">Sit back and relax! Our AI is analyzing the question paper and extracting all questions with their marks. This usually takes a few moments.</p>
</div>
</div>

<!-- Motivational Quote Card (Inside blue box) -->
<div class="bg-white dark:bg-slate-700 rounded-xl p-5 border-l-4 border-primary shadow-md">
<p class="text-lg font-medium text-text-dark dark:text-text-light italic leading-relaxed" id="extractionQuote">AI is analyzing your question paper and extracting questions. This process continues in the background.</p>
</div>
</div>
</div>

<!-- Verification Pending Section (shown after extraction completes) -->
<div id="verificationPendingSection" class="hidden mb-6">
<div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-6 border-l-4 border-accent-yellow shadow-md">
<div class="flex items-start gap-4">
<span class="material-symbols-outlined text-3xl text-accent-yellow">pending_actions</span>
<div class="flex-1">
<h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">Question Extraction Complete!</h3>
<p class="text-base text-text-dark/70 dark:text-text-light/70 mb-4">AI has extracted <span id="extractedQuestionsCount" class="font-semibold">0</span> questions from your question paper. Please verify and finalize the questions before uploading answer sheets.</p>
<button onclick="goToVerification()" class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-md">
<span class="material-symbols-outlined">fact_check</span>
<span>Verify Questions Now</span>
</button>
</div>
</div>
</div>
</div>

<!-- Answer Sheet Processing Progress Section (Full Screen Centered) -->
<div id="answerSheetProcessingSection" class="hidden fixed inset-0 bg-background-light dark:bg-background-dark z-40 overflow-y-auto">
    <div class="min-h-screen flex items-center justify-center p-4 md:p-8">
        <div class="max-w-2xl w-full">
            <!-- Assessment Details Card with White Background -->
            <div class="bg-white dark:bg-slate-800 rounded-xl p-8 mb-6 shadow-lg">
                <div class="flex items-start gap-4 mb-6">
                    <span class="material-symbols-outlined text-3xl text-primary dark:text-blue-400 animate-spin">autorenew</span>
                    <div class="flex-1">
                        <h1 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">AI is Processing Answer Sheet...</h1>
                        <p class="text-base text-text-dark/70 dark:text-text-light/70">Sit back and relax! Our AI is extracting student information and grading the answers. This usually takes a few moments.</p>
                    </div>
                </div>
                
                <!-- Assessment Details -->
                <div id="processingAssessmentDetails" class="bg-gradient-to-r from-accent-yellow/20 to-accent-yellow/5 dark:from-accent-yellow/10 dark:to-accent-yellow/5 rounded-xl p-5 space-y-3 border-l-4 border-accent-yellow">
                    <!-- Will be populated by JS -->
                </div>
            </div>
            
            <!-- Motivational Quote Card (Outside main card) -->
            <div class="bg-white dark:bg-slate-700 rounded-xl p-6 border-l-4 border-primary shadow-md mb-6">
                <p id="processingQuote" class="text-lg font-medium text-text-dark dark:text-text-light italic leading-relaxed"></p>
            </div>
            
            <!-- Back Button Below Card -->
            <div class="flex justify-center mt-6">
                <div class="text-center">
                    <button onclick="hideAnswerSheetProcessing()" class="px-6 py-3 bg-primary hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-md flex items-center gap-2 mx-auto">
                        <span class="material-symbols-outlined">arrow_back</span>
                        <span>Back to Assessment Details</span>
                    </button>
                    <p class="text-xs text-text-dark/60 dark:text-text-light/60 mt-2">Processing continues in background. Come back later to verify grades.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Grading Progress (shown only for In Progress assessments) -->
<div id="gradingProgressSection" class="hidden mb-6">
<!-- Main Card with Blue Background -->
<div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6 border-l-4 border-primary shadow-md">
<div class="flex items-start gap-4 mb-6">
<span class="material-symbols-outlined text-3xl text-primary dark:text-blue-400 animate-spin">autorenew</span>
<div class="flex-1">
<h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">AI is Grading Your Assessment</h3>
<p class="text-base text-text-dark/70 dark:text-text-light/70">Sit back and relax! Our AI is analyzing all student responses. This usually takes a few minutes. We'll notify you once grading is complete.</p>
</div>
</div>

<!-- Inspirational Quote Card -->
<div class="bg-white dark:bg-slate-700 rounded-xl p-5 border-l-4 border-primary shadow-md">
<p class="text-lg font-medium text-text-dark dark:text-text-light italic leading-relaxed" id="inspirationalQuote">The beautiful thing about learning is that no one can take it away from you.</p>
</div>
</div>
</div>

<!-- View Questions Section (shown after verification) -->
<div id="viewQuestionsSection" class="hidden mb-6">
<div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl shadow-md border-l-4 border-primary overflow-hidden">
<div class="px-4 md:px-6 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4">
<div>
<h2 class="text-lg md:text-xl font-bold text-text-dark dark:text-text-light">Assessment Questions</h2>
<p class="text-xs md:text-sm text-text-dark/70 dark:text-text-light/70 mt-1">View the verified questions for this assessment</p>
</div>
<div class="flex flex-col md:flex-row items-stretch md:items-center gap-2 md:gap-3">
<button onclick="downloadQuestions()" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 md:py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors text-sm">
<span class="material-symbols-outlined text-lg">download</span>
<span>Download Questions</span>
</button>
<button onclick="toggleQuestionsView()" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 md:py-2 bg-primary hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors text-sm">
<span class="material-symbols-outlined text-lg" id="questionsToggleIcon">visibility</span>
<span id="questionsToggleText">View Questions</span>
</button>
</div>
</div>

<!-- Collapsible Questions Content -->
<div id="questionsContent" class="hidden">
<div class="p-6 bg-white/50 dark:bg-slate-900/50">
<div class="mb-4 flex items-center justify-between">
<div class="text-sm text-text-dark/70 dark:text-text-light/70">
Total Questions: <span id="questionsCount" class="font-bold text-primary">0</span> |
Total Marks: <span id="questionsTotalMarks" class="font-bold text-green-600 dark:text-green-400">0</span>
</div>
<button id="editQuestionsBtn" onclick="window.location.href='/verify-questions?id=' + assessmentId" class="inline-flex items-center gap-1 text-sm text-primary hover:text-blue-700 font-medium" style="display: none;">
<span class="material-symbols-outlined text-base">edit</span>
Edit Questions
</button>
</div>

<!-- Questions List -->
<div id="questionsList" class="space-y-3">
<!-- Questions will be loaded here -->
</div>
</div>
</div>
</div>
</div>

<!-- Answer Sheet Upload Section (shown only after verification) -->
<div id="answerSheetUploadSection" class="hidden mb-6">
<div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 md:p-6 border-l-4 border-green-500 shadow-md">
<div class="flex items-start gap-3 md:gap-4 mb-4">
<span class="material-symbols-outlined text-2xl md:text-3xl text-green-600 dark:text-green-400 flex-shrink-0">check_circle</span>
<div class="flex-1">
<h3 class="text-lg md:text-2xl font-bold text-text-dark dark:text-text-light mb-2">Questions Verified Successfully</h3>
<p class="text-sm md:text-base text-text-dark/70 dark:text-text-light/70">Your assessment has <span id="verifiedQuestionsCount" class="font-semibold">0</span> verified questions. You can now upload answer sheets for grading.</p>
</div>
</div>

<!-- Answer Sheet Upload Area -->
<div class="bg-white dark:bg-slate-700 rounded-xl p-4 md:p-6 border-2 border-dashed border-gray-300 dark:border-slate-600 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer" id="answerSheetArea" onclick="document.getElementById('answerSheetInput').click()">
<input type="file" id="answerSheetInput" class="hidden" accept=".pdf" onchange="handleAnswerSheetUpload(this)" multiple />
<div class="text-center">
<span class="material-symbols-outlined text-4xl md:text-5xl text-primary mb-2">upload_file</span>
<p class="text-base md:text-lg font-semibold text-text-dark dark:text-text-light mb-1">Upload Answer Sheets</p>
<p class="text-xs md:text-sm text-text-dark/70 dark:text-text-light/70">Click to upload or drag and drop PDF files here</p>
<p class="text-xs text-text-dark/60 dark:text-text-light/60 mt-2">You can upload multiple answer sheets at once</p>
</div>
</div>
</div>
</div>

<!-- Filters Section -->
<div class="mb-2 md:mb-6 bg-gray-50 dark:bg-slate-800/50 md:bg-transparent md:dark:bg-transparent -mx-4 md:mx-0 p-4 md:p-0">
<!-- Mobile: Grid Layout -->
<div class="flex flex-col gap-3 md:hidden">
<div class="grid grid-cols-1 gap-3">
<input
type="text"
id="filterStudentId"
placeholder="Student ID"
class="px-4 py-2.5 rounded-lg border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
oninput="applyFilters()"
/>

<input
type="text"
id="filterStudentName"
placeholder="Search by Name"
class="px-4 py-2.5 rounded-lg border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
oninput="applyFilters()"
/>
</div>

<div class="flex gap-3">
<select
id="filterStatus"
class="flex-1 pl-4 pr-10 py-2.5 rounded-lg border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
onchange="applyFilters()"
>
<option value="">All Status</option>
<option value="Pending">Pending</option>
<option value="Approved">Approved</option>
</select>

<button
onclick="clearFilters()"
class="px-6 py-2.5 text-sm font-medium text-primary hover:text-blue-700 dark:hover:text-blue-400 transition-colors whitespace-nowrap"
>
Clear
</button>
</div>
</div>

<!-- Desktop: Original Layout -->
<div class="hidden md:flex md:flex-row gap-4 items-center">
<input
type="text"
id="desktopFilterStudentId"
placeholder="Student ID"
class="w-auto px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
oninput="applyFilters()"
/>

<input
type="text"
id="desktopFilterStudentName"
placeholder="Search by Name"
class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
oninput="applyFilters()"
/>

<select
id="desktopFilterStatus"
class="w-auto pl-4 pr-10 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm font-medium focus:ring-2 focus:ring-primary focus:border-transparent"
onchange="applyFilters()"
>
<option value="">All Status</option>
<option value="Pending">Pending</option>
<option value="Approved">Approved</option>
</select>

<button
onclick="clearFilters()"
class="w-auto px-4 py-2 text-sm font-medium text-primary hover:text-blue-700 dark:hover:text-blue-400 transition-colors whitespace-nowrap"
>
Clear
</button>
</div>
</div>

<!-- Students Table -->
<div class="-mx-4 md:mx-0 bg-white dark:bg-slate-800 md:rounded-xl shadow-lg md:border border-border-light dark:border-border-dark overflow-hidden">
<div class="px-4 md:px-6 py-3 md:py-4 md:border-b border-gray-200 dark:border-gray-700">
<h2 class="text-lg md:text-xl font-bold">Student Results</h2>
<p class="text-xs md:text-sm text-text-dark/70 dark:text-text-light/70 mt-1">Review and approve student grades</p>
</div>

<!-- Desktop Table View -->
<div class="overflow-x-auto hidden md:block">
<table class="w-full min-w-[700px]">
<thead class="bg-primary">
<tr>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Student ID</th>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Student Name</th>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Marks</th>
<th class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">Status</th>
<th class="px-6 py-5 text-center text-sm font-bold text-white uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="studentsTableBody">
<!-- Students will be dynamically generated here -->
</tbody>
</table>
</div>

<!-- Mobile Card View -->
<div class="md:hidden" id="studentsCardView">
<!-- Cards will be dynamically generated here -->
</div>

<!-- Table Footer -->
<div class="px-4 md:px-6 py-3 md:py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-700/50">
<div class="text-xs md:text-sm text-text-dark/70 dark:text-text-light/70">
Total Students: <span id="totalStudents" class="font-semibold">0</span>
</div>
</div>
</div>
</div>
</main>

<!-- Footer -->
<footer class="flex justify-center w-full mt-10 border-t border-border-light dark:border-border-dark">
<div class="w-full max-w-7xl px-4 py-8 md:px-8">
<div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
<div class="flex items-center gap-3">
<div class="text-primary size-6">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-lg font-bold">SuperrJump</h2>
</div>
</div>
</div>
</footer>
</div>

<script>
// Check if user is logged in
const user = JSON.parse(sessionStorage.getItem('user'));

if (!user) {
    window.location.href = '/home';
} else {
    const orgName = user.organization || user.organisationName || user.organisation || 'SuperrJump Academy';
    document.getElementById('orgName').textContent = orgName;
}

function logout() {
    sessionStorage.removeItem('user');
    window.location.href = '/home';
}

// Sidebar toggle functionality
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('sidebarBackdrop');
    
    if (sidebar.classList.contains('-translate-x-full')) {
        sidebar.classList.remove('-translate-x-full');
        backdrop.classList.remove('hidden');
    } else {
        sidebar.classList.add('-translate-x-full');
        backdrop.classList.add('hidden');
    }
}

// API configuration
const API_BASE_URL = '/api';

// Get assessment ID from URL
const urlParams = new URLSearchParams(window.location.search);
const assessmentId = urlParams.get('id');

// Handle browser back button - show logout confirmation
window.addEventListener('popstate', (event) => {
    const token = sessionStorage.getItem('token');
    
    if (token) {
        // Prevent actual navigation
        window.history.pushState(null, null, window.location.href);
        
        // Show confirmation dialog
        const confirmed = confirm('Going back will log you out. Do you want to continue?');
        
        if (confirmed) {
            // User confirmed - log out and redirect to login
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.replace('/home');
        }
    }
});



if (!assessmentId) {
    window.location.href = '/assessments';
}

// Store assessment data
let assessmentData = null;

// Load assessment details from API
async function loadAssessmentDetails() {
    try {
        // Get JWT token from session
        const token = sessionStorage.getItem('token');
        
        if (!token) {
            // Redirect to login if no token
            window.location.href = '/home';
            return;
        }
        
        // Fetch assessment from API
        const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}`, {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.status === 401 || response.status === 403) {
            // Token expired or invalid - redirect to login
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.href = '/home';
            return;
        }
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        assessmentData = data.assessment;
        
        // Display assessment details
        const date = new Date(assessmentData.created_at);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        document.getElementById('assessmentTitle').textContent = assessmentData.title;
        document.getElementById('assessmentNumber').textContent = `#${assessmentData.id}`;
        document.getElementById('assessmentClass').textContent = assessmentData.class;
        document.getElementById('assessmentSubject').textContent = assessmentData.subject;
        document.getElementById('assessmentDate').textContent = dateStr;
        
        const statusBadge = document.getElementById('assessmentStatus');
        statusBadge.textContent = assessmentData.status;
        
        // Map status to CSS classes
        let statusClass = 'status-processing-ques'; // default
        if (assessmentData.status === 'Completed') {
            statusClass = 'status-completed';
        } else if (assessmentData.status === 'Extraction Failed') {
            statusClass = 'status-failed';
        } else if (assessmentData.status === 'Grading Failed') {
            statusClass = 'status-failed';
        } else if (assessmentData.status === 'Processing Ques') {
            statusClass = 'status-processing-ques';
        } else if (assessmentData.status === 'Ques Pending Approval') {
            statusClass = 'status-ques-pending';
        } else if (assessmentData.status === 'Processing Ans') {
            statusClass = 'status-processing-ans';
        } else if (assessmentData.status === 'Ans Pending Approval') {
            statusClass = 'status-ans-pending';
        }
        
        statusBadge.className = `status-badge ${statusClass}`;
        
        // Show appropriate section based on status
        if (assessmentData.status === 'Extraction Failed') {
            // Question extraction failed - show retry option
            showExtractionFailed();
        } else if (assessmentData.status === 'Processing Ques') {
            // AI is extracting questions - show loader
            showExtractionProgress();
        } else if (assessmentData.status === 'Ques Pending Approval') {
            // Questions extracted, need teacher verification
            if (assessmentData.question_count && assessmentData.question_count > 0) {
                document.getElementById('extractedQuestionsCount').textContent = assessmentData.question_count;
                showVerificationPending();
            } else {
                // Fallback to extraction progress if question count not available
                showExtractionProgress();
            }
        } else if (assessmentData.status === 'Ready for Grading' || assessmentData.status === 'Grading Failed') {
            // Questions verified and ready for answer sheet upload (or retry after grading failure)
            showCompletedState();
        } else if (assessmentData.status === 'Processing Ans') {
            // AI is grading answers - show grading progress with loader
            showGradingProgress();
        } else if (assessmentData.status === 'Ans Pending Approval') {
            // Grades ready for teacher review - show student results table for approval
            showCompletedState();
        } else if (assessmentData.status === 'Completed') {
            // Assessment fully completed - show student results table
            showCompletedState();
        }
    } catch (error) {
        console.error('Error fetching assessment:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        alert('Failed to load assessment details: ' + error.message + '. Redirecting to assessments page...');
        setTimeout(() => {
            window.location.href = '/assessments';
        }, 2000);
    }
}

// Show extraction progress section
function showExtractionProgress() {
    const extractionSection = document.getElementById('extractionProgressSection');
    extractionSection.classList.remove('hidden');
    
    // Start rotating extraction quotes
    rotateExtractionQuotes();
    
    // Start polling for extraction completion
    pollExtractionStatus();
}

// Rotate extraction quotes
function rotateExtractionQuotes() {
    const quotes = [
        "AI is analyzing your question paper and extracting questions. This process continues in the background.",
        "Smart extraction means less manual work and more time for teaching.",
        "Our AI understands question patterns across different subjects and formats.",
        "Extracting questions automatically saves hours of manual data entry.",
        "Technology working behind the scenes to make your life easier."
    ];
    const quoteElement = document.getElementById('extractionQuote');
    
    if (!quoteElement) return;
    
    // Add transition style
    quoteElement.style.transition = 'opacity 0.3s ease';
    
    let quoteIndex = 0;
    
    // Change quote every 6 seconds with fade effect
    const quoteInterval = setInterval(() => {
        // Check if section is still visible
        if (document.getElementById('extractionProgressSection').classList.contains('hidden')) {
            clearInterval(quoteInterval);
            return;
        }
        
        quoteIndex = (quoteIndex + 1) % quotes.length;
        quoteElement.style.opacity = '0';
        
        setTimeout(() => {
            quoteElement.textContent = quotes[quoteIndex];
            quoteElement.style.opacity = '1';
        }, 300);
    }, 6000);
}

// Poll backend for extraction status
let extractionPollInterval = null;

async function pollExtractionStatus() {
    // Clear any existing poll interval
    if (extractionPollInterval) {
        clearInterval(extractionPollInterval);
    }
    
    // Poll every 5 seconds
    extractionPollInterval = setInterval(async () => {
        try {
            const token = sessionStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const assessment = data.assessment;
                
                // Check if status changed from "Processing Ques"
                if (assessment.status !== 'Processing Ques') {
                    clearInterval(extractionPollInterval);
                    // Reload page to show new status
                    window.location.reload();
                }
            }
        } catch (error) {
            console.error('Error polling extraction status:', error);
        }
    }, 5000); // Check every 5 seconds
}

// Stop polling when page is unloaded
window.addEventListener('beforeunload', () => {
    if (extractionPollInterval) {
        clearInterval(extractionPollInterval);
    }
});

// Show verification pending section (after extraction completes)
function showVerificationPending() {
    const verificationSection = document.getElementById('verificationPendingSection');
    
    // Use actual question count from assessment data
    const extractedCount = assessmentData?.question_count || 0;
    document.getElementById('extractedQuestionsCount').textContent = extractedCount;
    
    // Show the verification section
    verificationSection.classList.remove('hidden');
}

// Show answer sheet upload section (after verification)
function showAnswerSheetUpload() {
    const uploadSection = document.getElementById('answerSheetUploadSection');
    
    // Use actual question count from assessment data
    const verifiedCount = assessmentData?.question_count || 0;
    document.getElementById('verifiedQuestionsCount').textContent = verifiedCount;
    
    // Show the upload section
    uploadSection.classList.remove('hidden');
}

// Show grading progress message (during student detection or AI grading)
async function showGradingProgress() {
    // Always show "AI is Grading" message when assessment status is "Processing Ans"
    // This covers both student detection phase and actual grading phase
    const progressSection = document.getElementById('gradingProgressSection');
    progressSection.classList.remove('hidden');
    
    // Rotate inspirational quotes
    rotateQuotes();
    
    // Start polling to check when all grading is complete
    pollGradingStatus();
}

// Show extraction failed state - allow retry
function showExtractionFailed() {
    const extractionSection = document.getElementById('extractionProgressSection');
    
    if (!extractionSection) {
        console.error('extractionProgressSection element not found');
        return;
    }
    
    extractionSection.classList.remove('hidden');
    
    // Replace content with retry option
    extractionSection.innerHTML = `
        <div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-6 border-l-4 border-red-500 shadow-md">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                    <span class="material-symbols-outlined text-5xl text-red-600 dark:text-red-400">error</span>
                </div>
                <h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-3">Question Extraction Failed</h3>
                <p class="text-base text-text-dark/70 dark:text-text-light/70 mb-6">
                    The AI was unable to extract questions from the question paper. This could be due to poor image quality, unclear text, or formatting issues.
                </p>
                <button onclick="uploadNewQuestionPaper()" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-primary hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors mx-auto">
                    <span class="material-symbols-outlined">upload_file</span>
                    <span>Upload Different Question Paper</span>
                </button>
                <p class="text-sm text-text-dark/60 dark:text-text-light/60 mt-6">
                    üí° Tip: Ensure the question paper has clear, readable text and proper formatting for better extraction results.
                </p>
            </div>
        </div>
    `;
}

// Upload new question paper and start AI extraction
function uploadNewQuestionPaper() {
    // Trigger file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/pdf';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            // Show loading state
            const extractionSection = document.getElementById('extractionProgressSection');
            extractionSection.innerHTML = `
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6 border-l-4 border-primary shadow-md">
                    <div class="flex items-start gap-4">
                        <span class="material-symbols-outlined text-3xl text-primary dark:text-blue-400 animate-spin">autorenew</span>
                        <div class="flex-1">
                            <h3 class="text-2xl font-bold text-text-dark dark:text-text-light mb-2">Uploading New Question Paper...</h3>
                            <p class="text-base text-text-dark/70 dark:text-text-light/70 mb-4">Please wait while we upload and start extracting questions.</p>
                        </div>
                    </div>
                </div>
            `;
            
            const formData = new FormData();
            formData.append('questionPaper', file);
            
            const token = sessionStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/assessments/${assessmentData.id}/update-question-paper`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Failed to upload new question paper');
            }
            
            // Save extraction state for showing progress screen
            const extractionState = {
                assessmentNumber: assessmentData.id,
                formData: {
                    id: assessmentData.id,
                    title: assessmentData.title,
                    class: assessmentData.class,
                    subject: assessmentData.subject
                },
                startTime: new Date().toISOString(),
                isGrading: true,
                status: 'Processing Ques',
                returnToAssessment: assessmentData.id // Remember to return to this assessment
            };
            sessionStorage.setItem('gradingState', JSON.stringify(extractionState));
            sessionStorage.setItem('onExtractionScreen', 'true');
            
            // Navigate to extraction progress page
            window.location.href = `/create-assessment.html?retry=${assessmentData.id}`;
        } catch (error) {
            console.error('Error uploading new question paper:', error);
            alert('Failed to upload question paper. Please try again.');
        }
    };
    input.click();
}

// Show completed state (assessment fully graded)
function showCompletedState() {
    // Show questions section first (at the top)
    showQuestionsSection();
    
    // Only show answer sheet upload section if questions are approved
    // Status must be 'Ready for Grading', 'Grading Failed', 'Ans Pending Approval', or 'Completed'
    if (assessmentData.status === 'Ready for Grading' ||
        assessmentData.status === 'Grading Failed' ||
        assessmentData.status === 'Ans Pending Approval' ||
        assessmentData.status === 'Completed') {
        showAnswerSheetUpload();
    }
    
    // Show the student results table which is already rendered
    console.log('Assessment is completed - showing student results');
}

// Show questions section
function showQuestionsSection() {
    const questionsSection = document.getElementById('viewQuestionsSection');
    questionsSection.classList.remove('hidden');
    
    // Load questions data
    loadQuestionsForView();
}

// Download original question paper PDF
async function downloadQuestions() {
    try {
        if (!assessmentData?.question_paper_link) {
            return;
        }
        
        // Fetch the original PDF
        const response = await fetch(assessmentData.question_paper_link);
        if (!response.ok) {
            throw new Error('Failed to fetch PDF');
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const link = document.createElement('a');
        link.href = url;
        link.download = `${assessmentData.title || 'Assessment'}_Questions.pdf`;
        link.click();
        
        // Cleanup
        URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('Error downloading PDF:', error);
    }
}

// Toggle questions view
function toggleQuestionsView() {
    const content = document.getElementById('questionsContent');
    const toggleText = document.getElementById('questionsToggleText');
    const toggleIcon = document.getElementById('questionsToggleIcon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        toggleText.textContent = 'Hide Questions';
        toggleIcon.textContent = 'visibility_off';
    } else {
        content.classList.add('hidden');
        toggleText.textContent = 'View Questions';
        toggleIcon.textContent = 'visibility';
    }
}

// Load questions for view
async function loadQuestionsForView() {
    try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}/questions`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load questions');
        }
        
        const data = await response.json();
        const questions = data.questions || [];
        
        // Helper function to format numbers (remove unnecessary decimals)
        const formatNumber = (num) => {
            const parsed = parseFloat(num);
            if (isNaN(parsed)) return '0';
            return parsed % 1 === 0 ? Math.floor(parsed) : parsed;
        };
        
        // Update counts
        document.getElementById('questionsCount').textContent = questions.length;
        const totalMarks = questions.reduce((sum, q) => sum + parseFloat(q.max_marks || 0), 0);
        document.getElementById('questionsTotalMarks').textContent = formatNumber(totalMarks);
        
        // Show Edit Questions button only for Admin users
        const editQuestionsBtn = document.getElementById('editQuestionsBtn');
        console.log('User role:', user?.role);
        console.log('Edit button element:', editQuestionsBtn);
        if (user && user.role === 'Admin') {
            console.log('‚úÖ Admin user - showing Edit Questions button');
            editQuestionsBtn.style.display = 'inline-flex';
        } else {
            console.log('‚ùå Non-admin user - hiding Edit Questions button');
        }
        
        // Render questions list
        const questionsList = document.getElementById('questionsList');
        questionsList.innerHTML = '';
        
        if (questions.length === 0) {
            questionsList.innerHTML = '<p class="text-center text-gray-500 py-4">No questions found</p>';
            return;
        }
        
        questions.forEach((q, index) => {
            const questionCard = document.createElement('div');
            questionCard.className = 'bg-white dark:bg-slate-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow';
            
            const isOptional = q.is_optional || false;
            const optionalBadge = isOptional ? `
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 text-xs font-semibold rounded-full">
                    <span class="material-symbols-outlined" style="font-size: 14px;">alt_route</span>
                    OR
                </span>
            ` : '';
            
            questionCard.innerHTML = `
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center justify-center w-8 h-8 bg-primary text-white rounded-full font-bold text-sm">
                                ${q.question_number}
                            </span>
                            <span class="text-sm font-semibold text-text-dark dark:text-text-light">
                                Question ${q.question_number}
                            </span>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">
                                ${q.question_identifier || ''}
                            </span>
                            ${optionalBadge}
                        </div>
                        <p class="text-sm text-text-dark dark:text-text-light leading-relaxed line-clamp-2">
                            ${q.question_text || 'No question text'}
                        </p>
                        ${q.topics && q.topics.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${q.topics.slice(0, 3).map(t => `
                                    <span class="inline-flex items-center px-2 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 text-xs rounded-full">
                                        ${t.topic} ${t.weight ? t.weight + '%' : ''}
                                    </span>
                                `).join('')}
                                ${q.topics.length > 3 ? `<span class="text-xs text-gray-500">+${q.topics.length - 3} more</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="inline-flex items-center px-3 py-1.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 text-sm font-bold rounded-lg">
                            ${formatNumber(q.max_marks)} marks
                        </span>
                        ${q.verified ? `
                            <span class="inline-flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                                <span class="material-symbols-outlined" style="font-size: 14px;">check_circle</span>
                                Verified
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
            
            questionsList.appendChild(questionCard);
        });
        
    } catch (error) {
        console.error('Error loading questions:', error);
        document.getElementById('questionsList').innerHTML = '<p class="text-center text-red-500 py-4">Error loading questions</p>';
    }
}

// Simulate grading completion
function simulateGradingCompletion() {
    // Random time between 30-60 seconds
    const completionTime = Math.floor(Math.random() * 30000) + 30000;
    
    setTimeout(() => {
        // Update grading state to completed but keep the data
        const gradingState = sessionStorage.getItem('gradingState');
        if (gradingState) {
            try {
                const state = JSON.parse(gradingState);
                state.isGrading = false;
                state.status = 'Completed';
                state.completedAt = new Date().toISOString();
                sessionStorage.setItem('gradingState', JSON.stringify(state));
            } catch (error) {
                console.error('Error updating grading state:', error);
            }
        }
        
        // Update status to completed
        const statusBadge = document.getElementById('assessmentStatus');
        statusBadge.textContent = 'Completed';
        statusBadge.className = 'status-badge status-completed';
        
        // Hide grading progress section
        const progressSection = document.getElementById('gradingProgressSection');
        progressSection.classList.add('hidden');
        
        // Show completion notification
        showCompletionNotification();
    }, completionTime);
}

// Show success notification
function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center gap-3';
    notification.innerHTML = `
        <span class="material-symbols-outlined">check_circle</span>
        <div>
            <p class="font-semibold">${message}</p>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transition = 'opacity 0.3s ease';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Show error notification
function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center gap-3';
    notification.innerHTML = `
        <span class="material-symbols-outlined">error</span>
        <div>
            <p class="font-semibold">${message}</p>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transition = 'opacity 0.3s ease';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Show completion notification
function showCompletionNotification() {
    showSuccessNotification('Grading Complete! Your assessment has been graded successfully.');
}

// Toggle questions modal
function toggleQuestionsModal() {
    const modal = document.getElementById('questionsModal');
    if (modal.style.display === 'none' || !modal.style.display) {
        modal.style.display = 'flex';
        loadAssessmentQuestionsModal();
    } else {
        modal.style.display = 'none';
    }
}

// Load assessment questions for modal
async function loadAssessmentQuestionsModal() {
    try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}/questions`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();
        
        if (data.success && data.questions) {
            displayModalQuestions(data.questions);
        } else {
            document.getElementById('assessmentQuestionsList').innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400">
                    <span class="material-symbols-outlined text-4xl mb-2 block">error</span>
                    <p>Failed to load questions</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading assessment questions:', error);
        document.getElementById('assessmentQuestionsList').innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined text-4xl mb-2 block">error</span>
                <p>Error loading questions</p>
            </div>
        `;
    }
}

// Display questions in modal
function displayModalQuestions(questions) {
    const container = document.getElementById('assessmentQuestionsList');
    
    // Helper function to format numbers
    const formatNumber = (num) => {
        const parsed = parseFloat(num);
        if (isNaN(parsed)) return '0';
        return parsed % 1 === 0 ? Math.floor(parsed) : parsed;
    };
    
    if (!questions || questions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined text-4xl mb-2 block">quiz</span>
                <p>No questions found for this assessment</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = questions.map(q => `
        <div class="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
            <div class="flex items-start gap-3 mb-3">
                <span class="inline-flex items-center justify-center w-8 h-8 bg-primary text-white rounded-full font-bold text-sm flex-shrink-0">
                    ${q.question_number}
                </span>
                <div class="flex-1">
                    <h4 class="text-base font-semibold text-text-dark dark:text-text-light mb-2">Question ${q.question_number}</h4>
                    <div class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-slate-700 rounded-lg p-3 mb-2">
                        ${q.question_text}
                    </div>
                    <div class="flex items-center gap-4 text-sm">
                        <span class="font-semibold text-primary">${formatNumber(q.max_marks)} marks</span>
                        ${q.topics && q.topics.length > 0 ? `
                            <div class="flex items-center gap-1 text-gray-600 dark:text-gray-400">
                                <span class="material-symbols-outlined text-sm">school</span>
                                <span>${q.topics.map(t => t.topic).join(', ')}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Navigate to verification page
function goToVerification() {
    window.location.href = `/verify-questions?id=${assessmentId}`;
}

// Handle answer sheet upload - direct upload without modal
async function handleAnswerSheetUpload(input) {
    if (input.files && input.files.length > 0) {
        const file = input.files[0]; // Single file upload
        
        try {
            // Create form data
            const formData = new FormData();
            formData.append('answer_sheet', file);
            
            const token = sessionStorage.getItem('token');
            
            // Upload to new endpoint
            const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}/submissions/upload`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Failed to upload answer sheet');
            }
            
            // Show full-page processing view
            showAnswerSheetProcessing();
            
            // Start polling for completion
            pollAnswerSheetProcessing();
            
        } catch (error) {
            console.error('Error uploading answer sheet:', error);
            showErrorNotification('Failed to upload answer sheet: ' + error.message);
        }
        
        // Reset input
        input.value = '';
    }
}

// Show answer sheet processing view (full screen centered)
function showAnswerSheetProcessing() {
    // Populate assessment details in processing screen
    const detailsDiv = document.getElementById('processingAssessmentDetails');
    
    if (assessmentData && detailsDiv) {
        detailsDiv.innerHTML = `
            <div class="flex items-center gap-2 text-sm mb-2">
                <span class="material-symbols-outlined text-primary">tag</span>
                <span class="font-semibold text-text-dark dark:text-text-light">Assessment Number:</span>
                <span class="text-text-dark/70 dark:text-text-light/70">#${assessmentData.id}</span>
            </div>
            <div class="flex items-center gap-2 text-sm mb-2">
                <span class="material-symbols-outlined text-primary">title</span>
                <span class="font-semibold text-text-dark dark:text-text-light">Title:</span>
                <span class="text-text-dark/70 dark:text-text-light/70">${assessmentData.title}</span>
            </div>
            <div class="flex items-center gap-2 text-sm mb-2">
                <span class="material-symbols-outlined text-primary">school</span>
                <span class="font-semibold text-text-dark dark:text-text-light">Class:</span>
                <span class="text-text-dark/70 dark:text-text-light/70">${assessmentData.class}</span>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span class="material-symbols-outlined text-primary">book</span>
                <span class="font-semibold text-text-dark dark:text-text-light">Subject:</span>
                <span class="text-text-dark/70 dark:text-text-light/70">${assessmentData.subject}</span>
            </div>
        `;
    }
    
    // Show processing section (full screen overlay)
    document.getElementById('answerSheetProcessingSection').classList.remove('hidden');
    
    // Rotate quotes
    rotateProcessingQuotes();
}

// Hide processing view and show results
function hideAnswerSheetProcessing() {
    // Hide full-screen processing overlay
    document.getElementById('answerSheetProcessingSection').classList.add('hidden');
}

// Poll for answer sheet processing completion
let answerSheetPollInterval = null;

async function pollAnswerSheetProcessing() {
    // Clear any existing interval
    if (answerSheetPollInterval) {
        clearInterval(answerSheetPollInterval);
    }
    
    // Poll every 2 seconds
    answerSheetPollInterval = setInterval(async () => {
        try {
            const token = sessionStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}/submissions`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const submissions = data.submissions || [];
                
                // Check if any submission is still processing
                const hasProcessing = submissions.some(s => s.status === 'Processing');
                
                if (!hasProcessing) {
                    // All done! Stop polling and show results
                    clearInterval(answerSheetPollInterval);
                    answerSheetPollInterval = null;
                    
                    hideAnswerSheetProcessing();
                    await generateStudentResults();
                }
            }
        } catch (error) {
            console.error('Error polling answer sheet status:', error);
        }
    }, 2000);
}

// Rotate processing quotes
function rotateProcessingQuotes() {
    const motivationalQuotes = [
        "AI is analyzing the answer sheet and grading responses...",
        "Extracting student information from the answer sheet...",
        "Comparing answers with the marking scheme...",
        "Calculating marks for each question...",
        "Almost done! Finalizing the grading results..."
    ];
    const quoteElement = document.getElementById('processingQuote');
    
    if (!quoteElement) return;
    
    let currentIndex = 0;
    
    // Show first quote
    quoteElement.textContent = motivationalQuotes[currentIndex];
    
    // Rotate quotes every 5 seconds
    const quoteInterval = setInterval(() => {
        // Check if section is still visible
        if (document.getElementById('answerSheetProcessingSection').classList.contains('hidden')) {
            clearInterval(quoteInterval);
            return;
        }
        
        currentIndex = (currentIndex + 1) % motivationalQuotes.length;
        quoteElement.style.opacity = '0';
        
        setTimeout(() => {
            quoteElement.textContent = motivationalQuotes[currentIndex];
            quoteElement.style.opacity = '1';
        }, 300);
    }, 5000);
    
    // Add transition to quote element
    quoteElement.style.transition = 'opacity 0.3s ease';
}

// Poll for grading status
let gradingPollInterval = null;

async function pollGradingStatus() {
    // Clear any existing interval
    if (gradingPollInterval) {
        clearInterval(gradingPollInterval);
    }
    
    // Poll every 5 seconds
    gradingPollInterval = setInterval(async () => {
        try {
            const token = sessionStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}/submissions`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const submissions = data.submissions || [];
                
                // Check if any submission is still processing
                const hasProcessing = submissions.some(s => s.status === 'Processing');
                
                if (!hasProcessing) {
                    // All done! Stop polling and reload page
                    clearInterval(gradingPollInterval);
                    gradingPollInterval = null;
                    window.location.reload();
                }
            }
        } catch (error) {
            console.error('Error polling grading status:', error);
        }
    }, 5000);
}

// Stop polling when page is unloaded
window.addEventListener('beforeunload', () => {
    if (answerSheetPollInterval) {
        clearInterval(answerSheetPollInterval);
    }
    if (gradingPollInterval) {
        clearInterval(gradingPollInterval);
    }
});

// Rotate inspirational quotes
function rotateQuotes() {
    const quotes = [
        "The beautiful thing about learning is that no one can take it away from you.",
        "Education is the most powerful weapon which you can use to change the world.",
        "The expert in anything was once a beginner.",
        "Learning is a treasure that will follow its owner everywhere.",
        "The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice."
    ];
    const quoteElement = document.getElementById('inspirationalQuote');
    
    // Add transition style
    quoteElement.style.transition = 'opacity 0.3s ease';
    
    let quoteIndex = 0;
    
    // Change quote every 6 seconds with fade effect
    setInterval(() => {
        quoteIndex = (quoteIndex + 1) % quotes.length;
        quoteElement.style.opacity = '0';
        
        setTimeout(() => {
            quoteElement.textContent = quotes[quoteIndex];
            quoteElement.style.opacity = '1';
        }, 300);
    }, 6000);
}

// Track if we're currently polling
let submissionPollInterval = null;

// Generate student results from API
async function generateStudentResults() {
    const tbody = document.getElementById('studentsTableBody');
    const cardView = document.getElementById('studentsCardView');
    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading student submissions...</td></tr>';
    cardView.innerHTML = '<div class="p-4 text-center text-gray-500">Loading student submissions...</div>';
    
    try {
        const token = sessionStorage.getItem('token');
        
        // Fetch student submissions from API
        const response = await fetch(`${API_BASE_URL}/assessments/${assessmentId}/submissions`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch student submissions');
        }
        
        // Handle empty or malformed responses
        let data;
        try {
            const text = await response.text();
            data = text ? JSON.parse(text) : { submissions: [] };
        } catch (parseError) {
            console.warn('Failed to parse submissions response:', parseError);
            data = { submissions: [] };
        }
        
        const submissions = data.submissions || [];
        
        tbody.innerHTML = '';
        cardView.innerHTML = '';
        
        if (submissions.length === 0) {
            // Show elegant empty state placeholder
            const emptyStateContent = `
                <div class="flex flex-col items-center justify-center text-center">
                    <div class="mb-4">
                        <span class="material-symbols-outlined text-gray-400 dark:text-gray-500" style="font-size: 80px;">
                            upload_file
                        </span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-2">
                        No Student Answers Uploaded Yet
                    </h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 max-w-md">
                        ${assessmentData.status === 'Ques Pending Approval'
                            ? 'Please verify and approve questions before uploading answer sheets'
                            : assessmentData.status === 'Extraction Failed'
                            ? 'Question extraction failed. Please retry with a better quality PDF'
                            : assessmentData.status === 'Grading Failed'
                            ? 'Answer sheet grading failed. Please try uploading the answer sheet again'
                            : 'Upload answer sheets to get AI-powered grading and see results here'}
                    </p>
                    ${(assessmentData.status === 'Ready for Grading' ||
                       assessmentData.status === 'Grading Failed' ||
                       assessmentData.status === 'Ans Pending Approval' ||
                       assessmentData.status === 'Completed') ? `
                        <button onclick="document.getElementById('answerSheetInput')?.click()" class="px-6 py-3 bg-primary hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-md flex items-center gap-2">
                            <span class="material-symbols-outlined">cloud_upload</span>
                            ${assessmentData.status === 'Grading Failed' ? 'Retry Upload Answer Sheets' : 'Upload Answer Sheets'}
                        </button>
                    ` : assessmentData.status === 'Ques Pending Approval' ? `
                        <button onclick="goToVerification()" class="px-6 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-semibold transition-colors shadow-md flex items-center gap-2">
                            <span class="material-symbols-outlined">fact_check</span>
                            Verify Questions First
                        </button>
                    ` : assessmentData.status === 'Extraction Failed' ? `
                        <!-- No button shown - extraction failed section handles retry -->
                    ` : ''}
                </div>
            `;
            
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-16">${emptyStateContent}</td></tr>`;
            cardView.innerHTML = `<div class="p-6">${emptyStateContent}</div>`;
            document.getElementById('totalStudents').textContent = '0';
            return;
        }
        
        // Get total marks for the assessment
        const totalMarks = parseFloat(assessmentData.total_marks || 100);
        
        // Check if any submissions are in Processing status
        let hasProcessingSubmissions = false;
        
        submissions.forEach(submission => {
            const row = document.createElement('tr');
            row.className = 'student-row hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors';
            row.setAttribute('data-student-id', submission.student_id || 'N/A');
            row.setAttribute('data-student-name', (submission.student_name || '').toLowerCase());
            row.setAttribute('data-status', submission.status);
            
            // Track processing submissions for polling
            if (submission.status === 'Processing') {
                hasProcessingSubmissions = true;
            }
            
            // Format marks to remove trailing zeros
            const marksObtained = parseFloat(submission.total_marks_obtained || 0);
            const formattedMarks = marksObtained % 1 === 0 ? Math.floor(marksObtained) : marksObtained.toFixed(1);
            const formattedTotal = totalMarks % 1 === 0 ? Math.floor(totalMarks) : totalMarks;
            
            // Determine status class
            let statusClass = 'status-processing';
            const status = submission.status;
            if (status === 'Processing') {
                statusClass = 'status-processing';
            } else if (status === 'Ready for Verification') {
                statusClass = 'status-ready-for-verification';
            } else if (status === 'Verifying') {
                statusClass = 'status-verifying';
            } else if (status === 'Approved') {
                statusClass = 'status-approved';
            }
            
            // Determine action button
            let actionButton = '';
            if (status === 'Ready for Verification') {
                actionButton = `
                    <button onclick="verifyGrades(${submission.id})" class="inline-flex items-center justify-center gap-1 px-3 py-1.5 bg-primary hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-colors" title="Verify Grades">
                        <span class="material-symbols-outlined text-base">fact_check</span>
                        Verify
                    </button>
                `;
            } else if (status === 'Verifying' || status === 'Approved') {
                actionButton = `
                    <button onclick="viewStudentDetails(${submission.id})" class="inline-flex items-center justify-center w-9 h-9 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors" title="View Details">
                        <span class="material-symbols-outlined text-primary">visibility</span>
                    </button>
                `;
            } else if (status === 'Processing') {
                actionButton = `
                    <div class="flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary animate-spin">autorenew</span>
                    </div>
                `;
            }
            
            row.innerHTML = `
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <div class="text-sm font-semibold text-text-dark dark:text-text-light">${submission.student_identifier || 'N/A'}</div>
                </td>
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <div class="text-sm font-medium text-text-dark dark:text-text-light">${submission.student_name || 'Unknown'}</div>
                </td>
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <div class="text-sm font-semibold text-text-dark dark:text-text-light">${formattedMarks}/${formattedTotal}</div>
                </td>
                <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                    <span class="status-badge ${statusClass}">${status}</span>
                </td>
                <td class="px-6 py-4 text-center">
                    ${actionButton}
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Create mobile card
            const card = document.createElement('div');
            card.className = 'mx-4 mb-6 bg-white dark:bg-slate-700 rounded-xl shadow-md hover:shadow-lg border border-gray-200 dark:border-gray-600 overflow-hidden transition-all duration-200';
            card.setAttribute('data-student-id', submission.student_id || 'N/A');
            card.setAttribute('data-student-name', (submission.student_name || '').toLowerCase());
            card.setAttribute('data-status', submission.status);
            
            card.innerHTML = `
                <!-- Card Header -->
                <div class="bg-gradient-to-r from-primary to-blue-600 p-4">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="text-white/80 text-xs font-medium mb-1">${submission.student_identifier || 'N/A'}</div>
                            <h3 class="text-white font-bold text-lg leading-tight">${submission.student_name || 'Unknown'}</h3>
                        </div>
                        <span class="status-badge ${statusClass} text-xs">${status}</span>
                    </div>
                </div>
                
                <!-- Card Body -->
                <div class="p-4">
                    <!-- Marks Display -->
                    <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200 dark:border-gray-600">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-xl">school</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Marks Obtained</span>
                        </div>
                        <div class="text-2xl font-bold text-primary">
                            ${formattedMarks}<span class="text-base text-gray-500">/${formattedTotal}</span>
                        </div>
                    </div>
                    
                    <!-- Action Button -->
                    <div class="flex justify-end">
                        ${status === 'Ready for Verification' ? `
                            <button onclick="verifyGrades(${submission.id})" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-primary hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-lg">fact_check</span>
                                <span>Verify Grades</span>
                            </button>
                        ` : status === 'Verifying' || status === 'Approved' ? `
                            <button onclick="viewStudentDetails(${submission.id})" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-slate-600 dark:hover:bg-slate-500 text-text-dark dark:text-text-light font-semibold rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-lg">visibility</span>
                                <span>View Details</span>
                            </button>
                        ` : status === 'Processing' ? `
                            <div class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-50 dark:bg-blue-900/20 text-primary rounded-lg">
                                <span class="material-symbols-outlined text-lg animate-spin">autorenew</span>
                                <span class="font-medium">Processing...</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            cardView.appendChild(card);
        });
        
        document.getElementById('totalStudents').textContent = submissions.length;
        
        // Start or stop polling based on processing submissions
        if (hasProcessingSubmissions) {
            startSubmissionPolling();
        } else {
            stopSubmissionPolling();
        }
        
    } catch (error) {
        console.error('Error loading student submissions:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading student submissions</td></tr>';
        cardView.innerHTML = '<div class="p-4 text-center text-red-500">Error loading student submissions</div>';
    }
}

// Start polling for submission status updates
function startSubmissionPolling() {
    // Don't start if already polling
    if (submissionPollInterval) {
        return;
    }
    
    console.log('üîÑ Starting submission status polling...');
    
    // Poll every 3 seconds
    submissionPollInterval = setInterval(async () => {
        await generateStudentResults();
    }, 3000);
}

// Stop polling
function stopSubmissionPolling() {
    if (submissionPollInterval) {
        console.log('‚èπÔ∏è Stopping submission status polling');
        clearInterval(submissionPollInterval);
        submissionPollInterval = null;
    }
}

// Navigate to verify grades page
function verifyGrades(submissionId) {
    window.location.href = `/verify-grades?submissionId=${submissionId}&assessmentId=${assessmentData.id}`;
}

// View student details (for verifying/approved submissions)
function viewStudentDetails(submissionId) {
    window.location.href = `/verify-grades?submissionId=${submissionId}&assessmentId=${assessmentData.id}`;
}

// Stop polling when page is unloaded
window.addEventListener('beforeunload', () => {
    stopSubmissionPolling();
});

// Filter functionality
function applyFilters() {
    // Get filter values from whichever set of inputs is visible (mobile or desktop)
    const mobileStudentId = document.getElementById('filterStudentId')?.value || '';
    const desktopStudentId = document.getElementById('desktopFilterStudentId')?.value || '';
    const filterStudentId = (mobileStudentId || desktopStudentId).toLowerCase();
    
    const mobileStudentName = document.getElementById('filterStudentName')?.value || '';
    const desktopStudentName = document.getElementById('desktopFilterStudentName')?.value || '';
    const filterStudentName = (mobileStudentName || desktopStudentName).toLowerCase();
    
    const mobileStatus = document.getElementById('filterStatus')?.value || '';
    const desktopStatus = document.getElementById('desktopFilterStatus')?.value || '';
    const filterStatus = mobileStatus || desktopStatus;
    
    const rows = document.querySelectorAll('.student-row');
    const cards = document.querySelectorAll('#studentsCardView > div');
    let visibleCount = 0;
    
    // Filter table rows
    rows.forEach(row => {
        let showRow = true;
        
        const studentId = row.getAttribute('data-student-id').toLowerCase();
        const studentName = row.getAttribute('data-student-name');
        const status = row.getAttribute('data-status');
        
        // Apply Student ID filter
        if (filterStudentId && !studentId.includes(filterStudentId)) {
            showRow = false;
        }
        
        // Apply Student Name filter
        if (filterStudentName && !studentName.includes(filterStudentName)) {
            showRow = false;
        }
        
        // Apply Status filter
        if (filterStatus && status !== filterStatus) {
            showRow = false;
        }
        
        // Show/hide row
        if (showRow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Filter mobile cards
    cards.forEach(card => {
        let showCard = true;
        
        const studentId = card.getAttribute('data-student-id').toLowerCase();
        const studentName = card.getAttribute('data-student-name');
        const status = card.getAttribute('data-status');
        
        // Apply Student ID filter
        if (filterStudentId && !studentId.includes(filterStudentId)) {
            showCard = false;
        }
        
        // Apply Student Name filter
        if (filterStudentName && !studentName.includes(filterStudentName)) {
            showCard = false;
        }
        
        // Apply Status filter
        if (filterStatus && status !== filterStatus) {
            showCard = false;
        }
        
        // Show/hide card
        card.style.display = showCard ? 'block' : 'none';
    });
    
    // Update total count
    document.getElementById('totalStudents').textContent = visibleCount;
}

function clearFilters() {
    // Clear both mobile and desktop filter inputs
    const mobileStudentId = document.getElementById('filterStudentId');
    const desktopStudentId = document.getElementById('desktopFilterStudentId');
    const mobileStudentName = document.getElementById('filterStudentName');
    const desktopStudentName = document.getElementById('desktopFilterStudentName');
    const mobileStatus = document.getElementById('filterStatus');
    const desktopStatus = document.getElementById('desktopFilterStatus');
    
    if (mobileStudentId) mobileStudentId.value = '';
    if (desktopStudentId) desktopStudentId.value = '';
    if (mobileStudentName) mobileStudentName.value = '';
    if (desktopStudentName) desktopStudentName.value = '';
    if (mobileStatus) mobileStatus.value = '';
    if (desktopStatus) desktopStatus.value = '';
    
    const rows = document.querySelectorAll('.student-row');
    const cards = document.querySelectorAll('#studentsCardView > div');
    
    rows.forEach(row => {
        row.style.display = '';
    });
    
    cards.forEach(card => {
        card.style.display = 'block';
    });
    
    document.getElementById('totalStudents').textContent = rows.length;
}

// Go back to source page (handles multiple entry points)
function goBackToSource() {
    const urlParams = new URLSearchParams(window.location.search);
    const returnTo = urlParams.get('returnTo');
    
    if (returnTo === 'dashboard') {
        window.location.href = '/dashboard';
    } else {
        // Default to assessments page
        window.location.href = '/assessments';
    }
}

// Update back button text based on source
function updateBackButtonText() {
    const urlParams = new URLSearchParams(window.location.search);
    const returnTo = urlParams.get('returnTo');
    const backButtonText = document.getElementById('backButtonText');
    
    if (backButtonText) {
        if (returnTo === 'dashboard') {
            backButtonText.textContent = 'Back to Dashboard';
        } else {
            backButtonText.textContent = 'Back to Assessments';
        }
    }
}

// Initialize page
async function initializePage() {
    await loadAssessmentDetails(); // Wait for assessment data first
    await generateStudentResults(); // Then generate results with proper status check
    updateBackButtonText();
}

initializePage();
</script>


</body>
</html>
