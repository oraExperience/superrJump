
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Payment Status - SuperrJump</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        body {
            font-family: 'Lexend', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 max-w-md w-full">
            
            <!-- Processing State -->
            <div id="processingState" class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Verifying Payment</h1>
                <p class="text-gray-600 dark:text-gray-300">Please wait while we confirm your payment...</p>
            </div>

            <!-- Success State -->
            <div id="successState" class="hidden text-center">
                <div class="mb-4">
                    <span class="material-symbols-outlined text-green-600 text-7xl">check_circle</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Payment Successful!</h1>
                <p class="text-gray-600 dark:text-gray-300 mb-6">Your subscription has been activated successfully.</p>
                <button onclick="window.location.href='/plans'" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    View Subscription Details
                </button>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden text-center">
                <div class="mb-4">
                    <span class="material-symbols-outlined text-red-600 text-7xl">error</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Payment Failed</h1>
                <p class="text-gray-600 dark:text-gray-300 mb-2" id="errorMessage">Something went wrong with your payment.</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">If amount was deducted, please contact support.</p>
                <button onclick="window.location.href='/plans'" class="w-full px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                    Return to Plans
                </button>
            </div>

        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const user = JSON.parse(sessionStorage.getItem('user'));
        const token = sessionStorage.getItem('token');

        // Get payment response from URL parameters
        const razorpay_payment_id = urlParams.get('razorpay_payment_id');
        const razorpay_order_id = urlParams.get('razorpay_order_id');
        const razorpay_signature = urlParams.get('razorpay_signature');

        if (!user || !token) {
            window.location.href = '/login';
        } else if (!razorpay_payment_id || !razorpay_order_id || !razorpay_signature) {
            showError('Invalid payment response');
        } else {
            verifyPayment();
        }

        async function verifyPayment() {
            try {
                // Get pending order from session
                const pendingOrder = JSON.parse(sessionStorage.getItem('pendingOrder') || '{}');
                
                if (!pendingOrder.plan) {
                    throw new Error('Payment session expired');
                }

                const response = await fetch('/api/payment/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        razorpay_order_id: razorpay_order_id,
                        razorpay_payment_id: razorpay_payment_id,
                        razorpay_signature: razorpay_signature,
                        plan: pendingOrder.plan
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Clear pending order
                    sessionStorage.removeItem('pendingOrder');
                    showSuccess();
                } else {
                    throw new Error(result.message || 'Payment verification failed');
                }
            } catch (error) {
                console.error('Payment verification error:', error);
                showError(error.message);
            }
        }

        function showSuccess() {
            document.getElementById('processingState').classList.add('hidden');
            document.getElementById('successState').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('processingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
</body>
</html>
