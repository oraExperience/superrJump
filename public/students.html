<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Students - SuperrJump</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2A6EBB",
                        "background-light": "#FFFFFF",
                        "background-dark": "#111821",
                        "accent-yellow": "#FFC857",
                        "accent-green": "#A2D7D2",
                        "text-dark": "#333333",
                        "text-light": "#F8FAFC",
                        "border-light": "#e7ecf3",
                        "border-dark": "#374151"
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-text-dark dark:text-text-light">
    <div class="relative flex min-h-screen w-full flex-col">
        <!-- Sidebar Menu -->
        <div id="sidebar"
            class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-slate-800 border-r border-border-light dark:border-border-dark transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- Sidebar Header -->
                <div
                    class="flex items-center justify-between px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <div class="flex items-center gap-2">
                        <div class="text-primary size-5">
                            <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <path clip-rule="evenodd"
                                    d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z"
                                    fill="currentColor" fill-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h2 class="text-base font-bold text-text-dark dark:text-text-light">SuperrJump</h2>
                    </div>
                    <button onclick="toggleSidebar()"
                        class="text-text-dark dark:text-text-light hover:text-primary transition-colors p-1">
                        <span class="material-symbols-outlined text-xl">close</span>
                    </button>
                </div>

                <!-- Sidebar Menu Items -->
                <nav class="flex-1 px-3 py-4 space-y-1">
                    <a href="/dashboard"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light text-sm transition-colors">
                        <span class="material-symbols-outlined text-xl">dashboard</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="/assessments"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light text-sm transition-colors">
                        <span class="material-symbols-outlined text-xl">assignment</span>
                        <span>Assessments</span>
                    </a>
                    <a href="/students"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-xl">school</span>
                        <span>Students</span>
                    </a>
                    <a href="/profile"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light text-sm transition-colors">
                        <span class="material-symbols-outlined text-xl">person</span>
                        <span>Profile</span>
                    </a>
                    <a href="/plans"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-text-dark dark:text-text-light text-sm transition-colors">
                        <span class="material-symbols-outlined text-xl">workspace_premium</span>
                        <span>Pricing Plans</span>
                    </a>
                </nav>

                <!-- Sidebar Footer -->
                <div class="mt-auto px-3 py-3 border-t border-border-light dark:border-border-dark">
                    <button onclick="logout()"
                        class="w-full flex items-center justify-center gap-2 px-3 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition-colors">
                        <span class="material-symbols-outlined text-xl">logout</span>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar Backdrop -->
        <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleSidebar()"></div>

        <!-- TopNavBar -->
        <header
            class="sticky top-0 z-30 flex items-center justify-center border-b border-border-light dark:border-border-dark bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
            <div class="flex items-center justify-between w-full max-w-7xl px-4 py-3 md:px-8">
                <div class="flex items-center gap-2 md:gap-3 text-text-dark dark:text-text-light">
                    <button onclick="toggleSidebar()"
                        class="p-1.5 md:p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors flex items-center justify-center">
                        <span class="material-symbols-outlined text-xl md:text-2xl">menu</span>
                    </button>
                    <a href="/dashboard" class="flex items-center gap-2 md:gap-3 hover:opacity-80 transition-opacity cursor-pointer">
                        <div class="text-primary flex items-center" style="width: 24px; height: 24px;">
                            <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <path clip-rule="evenodd"
                                    d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z"
                                    fill="currentColor" fill-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h2 class="hidden md:block text-base md:text-xl font-bold leading-none">SuperrJump</h2>
                    </a>
                    <a href="/plans" class="px-3 py-1.5 md:px-4 md:py-2 bg-gradient-to-r from-purple-600 to-primary text-white rounded-lg text-xs md:text-sm font-semibold hover:from-purple-700 hover:to-blue-700 transition-all shadow-md hover:shadow-lg flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-base md:text-lg">workspace_premium</span>
                        <span>Upgrade</span>
                    </a>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <span id="orgName" class="hidden md:inline text-xs md:text-sm font-medium truncate max-w-[150px] md:max-w-none">Organization Name</span>
                    <div class="relative group">
                        <button class="flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-2 rounded-full md:rounded-lg bg-primary/10 hover:bg-primary/20 text-primary transition-colors">
                            <span class="text-sm md:text-base font-bold md:hidden">?</span>
                            <span class="hidden md:inline text-sm font-semibold">Need help?</span>
                        </button>
                        <div class="absolute right-0 top-full mt-2 w-64 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-1 font-medium">Need Help? Please write to:</p>
                            <a href="mailto:superrjump1@gmail.com" class="text-xs text-primary hover:underline font-medium">superrjump1@gmail.com</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex flex-col items-center w-full flex-1">
            <div class="w-full max-w-7xl px-4 md:px-8 py-6 md:py-10">
                <!-- Page Header -->
                <div
                    class="mb-6 md:mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4 bg-gradient-to-r from-accent-yellow/20 to-accent-yellow/5 dark:from-accent-yellow/10 dark:to-accent-yellow/5 p-4 md:p-6 rounded-xl border-l-4 border-accent-yellow">
                    <div>
                        <h1 class="text-lg md:text-3xl font-bold mb-1 md:mb-2">Students</h1>
                        <p class="text-xs md:text-base text-text-dark/70 dark:text-text-light/70">Manage your student database</p>
                    </div>
                    <div class="flex flex-row gap-2 md:gap-3 w-full md:w-auto">
                        <button onclick="openBulkUploadModal()"
                            class="flex items-center justify-center gap-2 px-4 py-2.5 md:px-6 md:py-3 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light border border-gray-300 dark:border-slate-600 rounded-lg font-semibold shadow-sm hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors text-xs md:text-base">
                            <span class="material-symbols-outlined !text-base md:!text-xl">upload_file</span>
                            <span>Bulk Upload</span>
                        </button>
                        <button onclick="openAddStudentModal()"
                            class="flex items-center justify-center gap-2 px-4 py-2.5 md:px-6 md:py-3 bg-accent-yellow text-text-dark rounded-lg font-semibold shadow-sm transition-transform hover:scale-105 text-xs md:text-base">
                            <span class="material-symbols-outlined !text-base md:!text-xl">add</span>
                            <span>Add Student</span>
                        </button>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="mb-6">
                    <!-- Mobile: Two rows, Desktop: Single row -->
                    <div class="flex flex-col md:flex-row gap-3 md:gap-4">
                        <!-- Search Input (Full width on mobile, flex-1 on desktop) -->
                        <div class="relative w-full md:flex-1 md:min-w-[200px]">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[20px]">search</span>
                            <input type="text" id="searchInput" placeholder="Search students..."
                                class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
                                oninput="filterStudents()">
                        </div>
                        
                        <!-- Class Filter and Clear (Row on mobile, inline on desktop) -->
                        <div class="flex gap-3 md:contents">
                            <select id="classFilter"
                                class="flex-1 md:flex-none md:w-auto px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-text-dark dark:text-text-light text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none cursor-pointer md:min-w-[140px]"
                                onchange="filterStudents()">
                                <option value="">All Classes</option>
                                <!-- Options populated dynamically -->
                            </select>
                            <button onclick="clearFilters()"
                                class="px-4 py-2 text-sm font-medium text-primary hover:text-blue-700 dark:hover:text-blue-400 transition-colors whitespace-nowrap">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div
                    class="-mx-4 md:mx-0 bg-white dark:bg-slate-800 md:rounded-xl shadow-lg md:border border-border-light dark:border-border-dark overflow-hidden">
                    <!-- Desktop Table View -->
                    <div class="overflow-x-auto hidden md:block">
                        <table class="w-full" style="min-width: 1200px;">
                            <thead class="bg-primary">
                                <tr>
                                    <th
                                        class="sticky left-0 z-10 px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30 bg-primary shadow-[4px_0_8px_rgba(0,0,0,0.1)]"
                                        style="min-width: 220px;">
                                        Student Name</th>
                                    <th
                                        class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30"
                                        style="min-width: 180px;">
                                        Student ID</th>
                                    <th
                                        class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">
                                        Class</th>
                                    <th
                                        class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">
                                        Roll No.</th>
                                    <th
                                        class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">
                                        Email</th>
                                    <th
                                        class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">
                                        Phone</th>
                                    <th
                                        class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">
                                        Parent Name</th>
                                    <th
                                        class="px-6 py-5 text-left text-sm font-bold text-white uppercase tracking-wider border-r border-white/30">
                                        Parent Phone</th>
                                    <th
                                        class="sticky right-0 z-10 px-6 py-5 text-center text-sm font-bold text-white uppercase tracking-wider bg-primary border-l border-gray-300 dark:border-slate-500 shadow-[-4px_0_8px_rgba(0,0,0,0.1)]">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Rows populated dynamically -->
                                <tr>
                                    <td class="sticky left-0 z-10 bg-white dark:bg-slate-800"></td>
                                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                        <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                                        <p>Loading students...</p>
                                    </td>
                                    <td class="sticky right-0 z-10 bg-white dark:bg-slate-800"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card View -->
                    <div class="md:hidden" id="studentsCardView">
                        <!-- Cards will be dynamically generated here -->
                    </div>

                    <!-- Pagination -->
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="text-sm text-text-dark/70 dark:text-text-light/70">
                            Showing <span id="showingFrom">1</span> to <span id="showingTo">10</span> of <span id="totalStudents">0</span> students
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="prevPageBtn" onclick="changePage('prev')"
                                class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                                <span class="material-symbols-outlined !text-xl">chevron_left</span>
                            </button>
                            <div id="paginationButtons" class="flex items-center gap-1">
                                <!-- Page buttons will be generated dynamically -->
                            </div>
                            <button id="nextPageBtn" onclick="changePage('next')"
                                class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined !text-xl">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="flex justify-center w-full border-t border-border-light dark:border-border-dark">
            <div class="w-full max-w-7xl px-4 py-8 md:px-8">
                <div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
                    <div class="flex items-center gap-3">
                        <div class="text-primary size-6">
                            <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <path clip-rule="evenodd"
                                    d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z"
                                    fill="currentColor" fill-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h2 class="text-lg font-bold">SuperrJump</h2>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add/Edit Student Modal -->
    <div id="studentModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all scale-100">
            <div
                class="px-6 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between bg-gray-50 dark:bg-slate-700/30">
                <h3 class="text-lg font-bold" id="modalTitle">Add New Student</h3>
                <button onclick="closeStudentModal()"
                    class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="studentForm" class="p-6 space-y-4">
                <input type="hidden" id="studentId">

                <div>
                    <label class="block text-sm font-medium mb-1">Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="studentName" required
                        class="w-full px-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Student ID <span class="text-red-500">*</span></label>
                    <input type="text" id="studentIdentifier" required
                        class="w-full px-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Class</label>
                        <input type="text" id="studentClass"
                            class="w-full px-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Roll Number</label>
                        <input type="text" id="studentRoll"
                            class="w-full px-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="studentEmail"
                        class="w-full px-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none">
                    <p id="emailError" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Phone</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 pointer-events-none">+91</span>
                        <input type="tel" id="studentPhone" maxlength="10" pattern="[0-9]*" inputmode="numeric"
                            placeholder="10 digit number"
                            class="w-full pl-14 pr-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                    <p id="phoneError" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Parent Name</label>
                    <input type="text" id="parentName"
                        class="w-full px-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Parent Phone</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 pointer-events-none">+91</span>
                        <input type="tel" id="parentPhone" maxlength="10" pattern="[0-9]*" inputmode="numeric"
                            placeholder="10 digit number"
                            class="w-full pl-14 pr-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-transparent focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                    <p id="parentPhoneError" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>

                <div class="pt-4 flex gap-3 justify-end">
                    <button type="button" onclick="closeStudentModal()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-slate-700 rounded-lg font-medium transition-colors">Cancel</button>
                    <button type="submit"
                        class="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-md">Save
                        Student</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div
                class="px-6 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
                <h3 class="text-lg font-bold text-text-dark dark:text-text-light">Bulk Upload Students</h3>
                <div class="flex items-center gap-3">
                    <a href="/api/students/sample-file" download
                        class="inline-flex items-center gap-1.5 px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[18px]">download</span>
                        Download Sample
                    </a>
                    <button onclick="closeBulkUploadModal()"
                        class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-5">
                <div class="text-sm text-gray-600 dark:text-gray-400 space-y-3">
                    <p>Upload an Excel file (.xlsx) to add or update students in bulk.</p>
                    <!-- <p>The file should have columns:
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Student Name</span>,
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Student ID</span>,
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Class</span>,
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Roll Number</span>,
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Email</span>,
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Phone</span> (10 digits, +91 added automatically),
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Parent Name</span>,
                        <span class="font-mono bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-xs">Parent Phone</span> (10 digits, +91 added automatically).
                    </p> -->
                </div>

                <div class="border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-lg p-8 text-center hover:border-primary hover:bg-gray-50 dark:hover:bg-slate-700/30 transition-all cursor-pointer"
                    onclick="document.getElementById('bulkFile').click()">
                    <input type="file" id="bulkFile" accept=".xlsx" class="hidden" onchange="handleFileSelect(this)">
                    <span class="material-symbols-outlined text-5xl text-gray-400 mb-3 block">upload_file</span>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" id="fileName">Click to upload file</p>
                    <p class="text-xs text-gray-500">.xlsx files only</p>
                </div>

                <!-- Progress/Status -->
                <div id="uploadStatus" class="hidden">
                    <div class="flex items-center gap-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <div class="animate-spin rounded-full h-5 w-5 border-2 border-primary border-t-transparent"
                            id="uploadSpinner"></div>
                        <span class="text-sm font-medium text-primary" id="uploadStatusText">Uploading...</span>
                    </div>
                </div>

                <!-- Results -->
                <div id="uploadResults" class="hidden p-4 bg-gray-50 dark:bg-slate-700/30 rounded-lg space-y-2">
                    <p class="text-sm text-green-600 dark:text-green-400 font-medium flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">check_circle</span>
                        <span id="successCount">0</span> students processed
                    </p>
                    <p class="text-sm text-red-600 dark:text-red-400 font-medium hidden flex items-center gap-2" id="errorCountContainer">
                        <span class="material-symbols-outlined text-[18px]">error</span>
                        <span id="errorCount">0</span> errors found
                    </p>
                    <button id="downloadErrorsBtn" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700 transition-colors shadow-sm hidden inline-flex items-center gap-2"
                        onclick="downloadErrorFile()">
                        <span class="material-symbols-outlined text-[18px]">download</span>
                        Download Error Report
                    </button>
                </div>

                <div class="flex gap-3 justify-end pt-3 border-t border-gray-200 dark:border-slate-600">
                    <button onclick="closeBulkUploadModal()"
                        class="px-5 py-2.5 text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-slate-700 rounded-lg font-medium text-sm transition-colors">Close</button>
                    <button onclick="uploadBulkFile()"
                        class="px-6 py-2.5 bg-green-600 text-white rounded-lg font-medium text-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                        id="uploadBtn" disabled>Upload</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Check Auth
        const user = JSON.parse(sessionStorage.getItem('user'));
        const token = sessionStorage.getItem('token');
        if (!user || !token) window.location.href = '/home';

        // Display organization name
        const orgName = user.organization || user.organisationName || user.organisation || 'SuperrJump Academy';
        document.getElementById('orgName').textContent = orgName;

        // Clear filters function
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('classFilter').value = '';
            filterStudents();
        }



        let allStudents = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let totalItems = 0;
        let totalPages = 0;

        // Load Students
        async function loadStudents(resetPage = false) {
            try {
                // First, get all students to calculate total for pagination
                const response = await fetch('/api/students?limit=10000', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    allStudents = data.students;
                    totalItems = allStudents.length;
                    totalPages = Math.ceil(totalItems / itemsPerPage);
                    populateClassFilter();
                    
                    // Reset to first page if requested or if current page is now out of bounds
                    if (resetPage || currentPage > totalPages) {
                        currentPage = 1;
                    }
                    
                    showPage(currentPage);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsTableBody').innerHTML = `
                    <tr><td colspan="9" class="px-6 py-8 text-center text-red-500">Failed to load students</td></tr>
                `;
            }
        }

        // Render Table and Cards
        function renderStudents(students) {
            const tbody = document.getElementById('studentsTableBody');
            const cardView = document.getElementById('studentsCardView');

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td class="sticky left-0 z-10 bg-white dark:bg-slate-800"></td>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <span class="material-symbols-outlined text-4xl mb-2 text-gray-300">school</span>
                            <p>No students found. Add one to get started!</p>
                        </td>
                        <td class="sticky right-0 z-10 bg-white dark:bg-slate-800 border-l border-gray-200 dark:border-slate-600"></td>
                    </tr>
                `;
                cardView.innerHTML = `
                    <div class="px-6 py-12 text-center">
                        <span class="material-symbols-outlined !text-6xl text-gray-400 mb-4">school</span>
                        <h3 class="text-xl font-semibold mb-2">No Students Yet</h3>
                        <p class="text-text-dark/70 dark:text-text-light/70 mb-6">Add students to get started</p>
                    </div>
                `;
                return;
            }

            // Render desktop table rows
            tbody.innerHTML = students.map(student => `
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors group">
                    <td class="sticky left-0 z-10 px-6 py-4 border-r border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800 group-hover:bg-gray-50 dark:group-hover:bg-slate-700/50 shadow-[4px_0_8px_rgba(0,0,0,0.1)]">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold text-sm">
                                ${student.student_name.charAt(0)}
                            </div>
                            <span class="font-medium text-text-dark dark:text-text-light">${student.student_name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                        <div class="text-sm font-mono text-text-dark/70 dark:text-text-light/70">${student.student_identifier}</div>
                    </td>
                    <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                        <div class="text-sm text-text-dark/70 dark:text-text-light/70">
                            ${student.class || '-'}
                        </div>
                    </td>
                    <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                        <div class="text-sm text-text-dark/70 dark:text-text-light/70">${student.roll_number || '-'}</div>
                    </td>
                    <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                        <div class="text-sm text-text-dark/70 dark:text-text-light/70">${student.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                        <div class="text-sm text-text-dark/70 dark:text-text-light/70">${student.phone || '-'}</div>
                    </td>
                    <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                        <div class="text-sm text-text-dark/70 dark:text-text-light/70">${student.parent_name || '-'}</div>
                    </td>
                    <td class="px-6 py-4 border-r border-gray-200 dark:border-slate-600">
                        <div class="text-sm text-text-dark/70 dark:text-text-light/70">${student.parent_phone || '-'}</div>
                    </td>
                    <td class="sticky right-0 z-10 px-6 py-4 text-center bg-white dark:bg-slate-800 group-hover:bg-gray-50 dark:group-hover:bg-slate-700/50 border-l border-gray-200 dark:border-slate-600 shadow-[-4px_0_8px_rgba(0,0,0,0.1)]">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="viewStudentSubmissions(${student.id})" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-slate-600 rounded-lg transition-colors" title="View Submissions">
                                <span class="material-symbols-outlined text-xl">assignment</span>
                            </button>
                            <button onclick="editStudent(${student.id})" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-600 rounded-lg transition-colors" title="Edit">
                                <span class="material-symbols-outlined text-xl">edit</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Render mobile cards
            cardView.innerHTML = students.map(student => `
                <div class="mx-4 mb-6 bg-white dark:bg-slate-700 rounded-xl shadow-md hover:shadow-lg border border-gray-200 dark:border-gray-600 overflow-hidden transition-all duration-200">
                    <!-- Card Header with colored accent -->
                    <div class="bg-gradient-to-r from-primary to-blue-600 p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="text-white/80 text-xs font-medium mb-1">ID: ${student.student_identifier}</div>
                                <h3 class="text-white font-bold text-xl leading-tight truncate">${student.student_name}</h3>
                            </div>
                            <div class="flex-shrink-0 w-12 h-12 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center ml-3">
                                <span class="text-white font-bold text-xl">${student.student_name.charAt(0).toUpperCase()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Body -->
                    <div class="p-4">
                        <!-- Student Info Grid - Always show all fields -->
                        <div class="grid grid-cols-2 gap-x-6 gap-y-4 pb-4 mb-4 border-b border-gray-200 dark:border-gray-600">
                            <!-- Class -->
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-primary text-xl flex-shrink-0">school</span>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">Class</div>
                                    <div class="font-bold text-text-dark dark:text-text-light truncate">${student.class || '-'}</div>
                                </div>
                            </div>
                            <!-- Roll Number -->
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-primary text-xl flex-shrink-0">tag</span>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">Roll No.</div>
                                    <div class="font-bold text-text-dark dark:text-text-light truncate">${student.roll_number || '-'}</div>
                                </div>
                            </div>
                            <!-- Email -->
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-primary text-xl flex-shrink-0">email</span>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">Email</div>
                                    <div class="font-bold text-sm text-text-dark dark:text-text-light truncate">${student.email || '-'}</div>
                                </div>
                            </div>
                            <!-- Phone -->
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-primary text-xl flex-shrink-0">phone</span>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">Phone</div>
                                    <div class="font-bold text-sm text-text-dark dark:text-text-light truncate">${student.phone || '-'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parent Information - Always show both fields -->
                        <div class="grid grid-cols-2 gap-x-6 gap-y-4 pb-4 mb-4 border-b border-gray-200 dark:border-gray-600">
                            <!-- Parent Name -->
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-primary text-xl flex-shrink-0">person</span>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">Parent Name</div>
                                    <div class="font-bold text-text-dark dark:text-text-light truncate">${student.parent_name || '-'}</div>
                                </div>
                            </div>
                            <!-- Parent Phone -->
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-primary text-xl flex-shrink-0">call</span>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">Parent Phone</div>
                                    <div class="font-bold text-sm text-text-dark dark:text-text-light truncate">${student.parent_phone || '-'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons - 2 column grid -->
                        <div class="grid grid-cols-2 gap-3 pt-1">
                            <button onclick="viewStudentSubmissions(${student.id})"
                                class="flex items-center justify-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-xl">assignment</span>
                                <span>Submissions</span>
                            </button>
                            <button onclick="editStudent(${student.id})"
                                class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-xl">edit</span>
                                <span>Edit</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Pagination functionality
        function renderPaginationButtons(dynamicTotalPages) {
            const container = document.getElementById('paginationButtons');
            container.innerHTML = '';

            const pagesToUse = dynamicTotalPages || totalPages;

            // Always show 3 center pages (current page Â± 1)
            const maxVisiblePages = 3;
            let startPage = 1;
            let endPage = pagesToUse;

            if (pagesToUse > maxVisiblePages) {
                // Show current page and one on each side
                startPage = Math.max(1, currentPage - 1);
                endPage = Math.min(pagesToUse, currentPage + 1);
            }

            // First page
            if (startPage > 1) {
                container.appendChild(createPageButton(1));
                if (startPage > 2) {
                    container.appendChild(createEllipsis());
                }
            }

            // Middle pages
            for (let i = startPage; i <= endPage; i++) {
                container.appendChild(createPageButton(i));
            }

            // Last page
            if (endPage < pagesToUse) {
                if (endPage < pagesToUse - 1) {
                    container.appendChild(createEllipsis());
                }
                container.appendChild(createPageButton(pagesToUse));
            }
        }

        function createPageButton(pageNum) {
            const button = document.createElement('button');
            button.onclick = () => goToPage(pageNum);
            button.className = 'page-btn w-9 h-9 rounded-lg font-medium text-sm transition-colors';

            if (pageNum === currentPage) {
                button.className += ' bg-primary text-white';
            } else {
                button.className += ' hover:bg-gray-100 dark:hover:bg-slate-600 text-text-dark dark:text-text-light';
            }

            button.textContent = pageNum;
            return button;
        }

        function createEllipsis() {
            const span = document.createElement('span');
            span.className = 'px-2 text-text-dark/70 dark:text-text-light/70';
            span.textContent = '...';
            return span;
        }

        function showPage(pageNum) {
            const filtered = getFilteredStudents();
            const visibleCount = filtered.length;
            const visibleTotalPages = Math.ceil(visibleCount / itemsPerPage);

            const startIndex = (pageNum - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            // Get students for current page
            const pageStudents = filtered.slice(startIndex, endIndex);
            renderStudents(pageStudents);

            // Update pagination info
            document.getElementById('showingFrom').textContent = visibleCount > 0 ? startIndex + 1 : 0;
            document.getElementById('showingTo').textContent = Math.min(endIndex, visibleCount);
            document.getElementById('totalStudents').textContent = visibleCount;

            // Render pagination buttons with updated total pages
            renderPaginationButtons(visibleTotalPages);

            // Update prev/next buttons
            document.getElementById('prevPageBtn').disabled = pageNum === 1;
            document.getElementById('nextPageBtn').disabled = pageNum >= visibleTotalPages;
        }

        function goToPage(pageNum) {
            currentPage = pageNum;
            showPage(currentPage);
        }

        function changePage(direction) {
            const filtered = getFilteredStudents();
            const visibleTotalPages = Math.ceil(filtered.length / itemsPerPage);
            
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < visibleTotalPages) {
                currentPage++;
            }
            showPage(currentPage);
        }

        function getFilteredStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const classFilter = document.getElementById('classFilter').value;

            return allStudents.filter(s => {
                const matchesSearch =
                    s.student_name.toLowerCase().includes(searchTerm) ||
                    s.student_identifier.toLowerCase().includes(searchTerm) ||
                    (s.roll_number && s.roll_number.toLowerCase().includes(searchTerm));

                const matchesClass = !classFilter || s.class === classFilter;

                return matchesSearch && matchesClass;
            });
        }

        // Filter Logic
        function filterStudents() {
            currentPage = 1; // Reset to first page when filtering
            showPage(currentPage);
        }

        document.getElementById('searchInput').addEventListener('input', filterStudents);
        document.getElementById('classFilter').addEventListener('change', filterStudents);

        function populateClassFilter() {
            const classes = [...new Set(allStudents.map(s => s.class).filter(Boolean))].sort();
            const select = document.getElementById('classFilter');
            
            select.innerHTML = '<option value="">All Classes</option>' +
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // Modal Functions
        const modal = document.getElementById('studentModal');
        const form = document.getElementById('studentForm');

        function openAddStudentModal() {
            document.getElementById('modalTitle').textContent = 'Add New Student';
            document.getElementById('studentId').value = '';
            form.reset();
            clearErrors();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // View Student Submissions
        function viewStudentSubmissions(id) {
            // Redirect to student submissions page (use clean URL to avoid redirect losing query params)
            window.location.href = `/student-submissions?studentId=${id}`;
        }

        function editStudent(id) {
            const student = allStudents.find(s => s.id === id);
            if (!student) return;

            document.getElementById('modalTitle').textContent = 'Edit Student';
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentName').value = student.student_name;
            document.getElementById('studentIdentifier').value = student.student_identifier;
            document.getElementById('studentClass').value = student.class || '';
            document.getElementById('studentRoll').value = student.roll_number || '';
            document.getElementById('studentEmail').value = student.email || '';
            
            // Parse student phone - remove +91 prefix if present
            if (student.phone) {
                const phoneWithoutCode = student.phone.replace(/^\+91/, '');
                document.getElementById('studentPhone').value = phoneWithoutCode;
            } else {
                document.getElementById('studentPhone').value = '';
            }
            
            document.getElementById('parentName').value = student.parent_name || '';
            
            // Parse parent phone - remove +91 prefix if present
            if (student.parent_phone) {
                const phoneWithoutCode = student.parent_phone.replace(/^\+91/, '');
                document.getElementById('parentPhone').value = phoneWithoutCode;
            } else {
                document.getElementById('parentPhone').value = '';
            }

            clearErrors();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeStudentModal() {
            clearErrors();
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Bulk Upload Functions
        const bulkModal = document.getElementById('bulkUploadModal');
        let selectedFile = null;
        let errorFileBase64 = null;

        function openBulkUploadModal() {
            bulkModal.classList.remove('hidden');
            bulkModal.classList.add('flex');
            resetBulkModal();
        }

        function closeBulkUploadModal() {
            bulkModal.classList.add('hidden');
            bulkModal.classList.remove('flex');
        }

        function resetBulkModal() {
            selectedFile = null;
            errorFileBase64 = null;
            document.getElementById('bulkFile').value = '';
            document.getElementById('fileName').textContent = 'Click to upload file';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadStatus').classList.add('hidden');
            document.getElementById('uploadResults').classList.add('hidden');
            document.getElementById('errorCountContainer').classList.add('hidden');
            document.getElementById('downloadErrorsBtn').classList.add('hidden');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        async function uploadBulkFile() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            // UI Updates
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadStatus').classList.remove('hidden');
            document.getElementById('uploadResults').classList.add('hidden');
            document.getElementById('uploadSpinner').classList.remove('hidden');
            document.getElementById('uploadStatusText').textContent = 'Processing file...';

            try {
                const response = await fetch('/api/students/bulk-upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await response.json();

                document.getElementById('uploadSpinner').classList.add('hidden');
                document.getElementById('uploadStatus').classList.add('hidden');
                document.getElementById('uploadResults').classList.remove('hidden');

                if (data.success) {
                    document.getElementById('successCount').textContent = data.summary.success;

                    if (data.summary.failed > 0) {
                        document.getElementById('errorCount').textContent = data.summary.failed;
                        document.getElementById('errorCountContainer').classList.remove('hidden');

                        if (data.errorFile) {
                            errorFileBase64 = data.errorFile;
                            document.getElementById('downloadErrorsBtn').classList.remove('hidden');
                        }
                    } else {
                        // Success with no errors
                        setTimeout(() => {
                            closeBulkUploadModal();
                            loadStudents(true);
                        }, 1500);
                    }

                    if (data.summary.success > 0) loadStudents(true);
                } else {
                    alert(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('uploadStatusText').textContent = 'Error uploading file';
                alert('An error occurred during upload');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function downloadErrorFile() {
            if (!errorFileBase64) return;

            const link = document.createElement('a');
            link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${errorFileBase64}`;
            link.download = 'upload_errors.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Helper function to show error
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        // Helper function to clear all errors
        function clearErrors() {
            document.getElementById('emailError').classList.add('hidden');
            document.getElementById('phoneError').classList.add('hidden');
            document.getElementById('parentPhoneError').classList.add('hidden');
        }

        // Form Submit
        form.addEventListener('submit', async function saveStudent(event) {
            event.preventDefault();
            
            // Clear previous errors
            clearErrors();

            const email = document.getElementById('studentEmail').value;
            const phoneNumber = document.getElementById('studentPhone').value;
            const parentPhoneNumber = document.getElementById('parentPhone').value;

            // Frontend Validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const phoneDigitsRegex = /^\d{10}$/;
            
            let hasError = false;

            if (email && !emailRegex.test(email)) {
                showError('emailError', 'Invalid email format');
                hasError = true;
            }

            if (phoneNumber && !phoneDigitsRegex.test(phoneNumber)) {
                showError('phoneError', 'Phone number must be exactly 10 digits');
                hasError = true;
            }

            if (parentPhoneNumber && !phoneDigitsRegex.test(parentPhoneNumber)) {
                showError('parentPhoneError', 'Parent phone number must be exactly 10 digits');
                hasError = true;
            }

            if (hasError) {
                return;
            }

            const studentId = document.getElementById('studentId').value;
            const isEdit = !!studentId;

            // Add +91 prefix to phone numbers
            const fullPhone = phoneNumber ? '+91' + phoneNumber : '';
            const fullParentPhone = parentPhoneNumber ? '+91' + parentPhoneNumber : '';

            const payload = {
                student_name: document.getElementById('studentName').value,
                student_identifier: document.getElementById('studentIdentifier').value,
                class: document.getElementById('studentClass').value,
                roll_number: document.getElementById('studentRoll').value,
                email: document.getElementById('studentEmail').value,
                phone: fullPhone,
                parent_name: document.getElementById('parentName').value,
                parent_phone: fullParentPhone,
                organisation: user.organisation || 'Default Org' // Fallback
            };

            try {
                const url = isEdit ? `/api/students/${studentId}` : '/api/students';
                const method = isEdit ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    closeStudentModal();
                    loadStudents(true); // Reload list and reset to first page
                } else {
                    alert(data.message || 'Operation failed');
                }
            } catch (error) {
                console.error('Error saving student:', error);
                alert('An error occurred. Please try again.');
            }
        });

        // Delete Student
        async function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student? This cannot be undone.')) return;

            try {
                const response = await fetch(`/api/students/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    loadStudents(true);
                } else {
                    alert(data.message || 'Failed to delete student');
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('An error occurred while deleting.');
            }
        }

        function logout() {
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.href = '/home';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');

            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        // Initial Load
        async function initializePage() {
            await loadStudents();
            
            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const classParam = urlParams.get('class');
            
            // If class parameter exists, apply the filter
            if (classParam) {
                setTimeout(() => {
                    const classSelect = document.getElementById('classFilter');
                    // Set the class filter value
                    classSelect.value = classParam;
                    // Trigger the filter
                    filterStudents();
                }, 100);
            }
        }
        
        initializePage();
    </script>
    <script src="/js/subscription-check.js"></script>
    <script>
        // Wrap student modal functions with subscription check
        const originalOpenAddStudentModal = openAddStudentModal;
        const originalOpenBulkUploadModal = openBulkUploadModal;
        
        openAddStudentModal = async function() {
            const hasActiveSubscription = await checkActiveSubscription();
            if (hasActiveSubscription) {
                originalOpenAddStudentModal();
            }
        };
        
        openBulkUploadModal = async function() {
            const hasActiveSubscription = await checkActiveSubscription();
            if (hasActiveSubscription) {
                originalOpenBulkUploadModal();
            }
        };
    </script>

    <script src="/js/trial-status.js"></script>

</body>

</html>